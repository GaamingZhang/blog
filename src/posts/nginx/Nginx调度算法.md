---
date: 2025-12-23
author: Gaaming Zhang
category:
  - Nginx
tag:
  - Nginx
---

# Nginx调度算法

## 概述

### 1. 调度算法概述
Nginx作为高性能的反向代理服务器，提供了多种负载均衡调度算法，用于将客户端请求分发到不同的后端服务器。选择合适的调度算法对系统性能、可靠性和用户体验至关重要。

### 2. 内置调度算法详解

#### 2.1 轮询 (Round Robin) - 默认算法
**工作原理**：将客户端请求按顺序依次分配给后端服务器，循环往复。

**配置示例**：
```nginx
upstream backend {
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}
```

**适用场景**：后端服务器性能相近、无状态服务、请求处理时间差异不大的场景。

**特点**：
- 实现简单，无需额外配置
- 均分请求，但不考虑服务器负载
- 可能导致负载不均衡（如服务器性能差异较大时）

#### 2.2 加权轮询 (Weighted Round Robin)
**工作原理**：根据后端服务器的权重值分配请求，权重大的服务器获得更多请求。

**配置示例**：
```nginx
upstream backend {
    server 192.168.1.101:8080 weight=3;
    server 192.168.1.102:8080 weight=2;
    server 192.168.1.103:8080 weight=1;
}
```

**适用场景**：后端服务器性能差异较大、需要按服务器能力分配负载的场景。

**特点**：
- 权重值越大，获得的请求越多
- 权重分配比为 `weight` 参数的比值
- Nginx 1.3.14+ 支持动态调整权重

#### 2.3 IP哈希 (IP Hash)
**工作原理**：根据客户端IP地址的哈希值分配请求，同一IP的请求始终分配到同一台后端服务器。

**配置示例**：
```nginx
upstream backend {
    ip_hash;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}
```

**适用场景**：需要会话保持（Session Sticky）的场景，如用户登录状态、购物车等。

**特点**：
- 保证同一客户端IP的请求固定到同一服务器
- 支持 `server` 指令的 `down` 参数临时禁用节点
- 存在哈希倾斜风险（如某些IP段请求量过大）

#### 2.4 最少连接 (Least Connections)
**工作原理**：将请求分配给当前活跃连接数最少的后端服务器。

**配置示例**：
```nginx
upstream backend {
    least_conn;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}
```

**适用场景**：请求处理时间差异较大的场景，如上传/下载服务、数据库查询等。

**特点**：
- 动态考虑服务器负载，更均衡分配请求
- 适用于长连接和短连接混合的场景
- 1.3.14+ 版本支持加权最少连接 (`least_conn` 与 `weight` 结合)

#### 2.5 加权最少连接 (Weighted Least Connections)
**工作原理**：结合权重和最少连接数，优先分配请求给权重/连接数比值最大的服务器。

**配置示例**：
```nginx
upstream backend {
    least_conn;
    server 192.168.1.101:8080 weight=3;
    server 192.168.1.102:8080 weight=2;
    server 192.168.1.103:8080 weight=1;
}
```

**适用场景**：后端服务器性能差异较大且请求处理时间不固定的场景。

**特点**：
- 综合考虑服务器性能和当前负载
- 计算公式：`weight / active_connections`
- 更智能的负载均衡策略

#### 2.6 最短响应时间 (Least Time) - Nginx Plus
**工作原理**：将请求分配给平均响应时间最短的后端服务器。

**配置示例**：
```nginx
upstream backend {
    least_time header;  # 或 least_time last_byte
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}
```

**适用场景**：对响应时间敏感的应用，如API服务、实时数据应用。

**特点**：
- `header`：测量接收到第一个字节的时间
- `last_byte`：测量接收到最后一个字节的时间
- 仅Nginx Plus支持

#### 2.7 URL哈希 (URL Hash)
**工作原理**：根据请求URL的哈希值分配请求，同一URL的请求始终分配到同一台后端服务器。

**配置示例**：
```nginx
upstream backend {
    hash $request_uri consistent;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}
```

**适用场景**：需要缓存一致性的场景，如静态资源服务器、CDN节点。

**特点**：
- `consistent` 参数启用一致性哈希算法
- 减少节点增减时的缓存失效
- 适用于内容缓存类服务

#### 2.8 随机算法 (Random)
**工作原理**：随机选择一台后端服务器处理请求。

**配置示例**：
```nginx
upstream backend {
    random;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}
```

**适用场景**：需要避免请求序列相关性的场景，如某些数据库负载均衡。

**特点**：
- 简单随机或加权随机
- 1.15.1+ 版本支持

### 3. 高级配置选项

#### 3.1 服务器状态参数
```nginx
upstream backend {
    server 192.168.1.101:8080 weight=3 max_fails=3 fail_timeout=30s;
    server 192.168.1.102:8080 backup;
    server 192.168.1.103:8080 down;
}
```

- `weight`：权重值
- `max_fails`：最大失败次数
- `fail_timeout`：失败超时时间
- `backup`：备份服务器
- `down`：临时禁用服务器

#### 3.2 会话保持配置
```nginx
upstream backend {
    sticky cookie srv_id expires=1h domain=.example.com path=/;
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
}
```

**注意**：`sticky` 模块需要单独编译安装或使用Nginx Plus。

## 高频面试题

### 1. Nginx默认的调度算法是什么？
**答案**：轮询（Round Robin）算法。它将客户端请求按顺序依次分配给后端服务器，实现简单但不考虑服务器负载差异。

### 2. 如何在Nginx中实现会话保持？
**答案**：主要有两种方式：
- 使用 `ip_hash` 指令，基于客户端IP地址分配请求
- 使用 `sticky` 模块（需单独安装），通过Cookie实现会话保持

### 3. 加权轮询和最少连接算法的区别是什么？
**答案**：
- 加权轮询：基于服务器权重静态分配请求，不考虑实际负载
- 最少连接：基于服务器当前活跃连接数动态分配请求，更均衡

### 4. 什么是一致性哈希？Nginx如何配置？
**答案**：一致性哈希是一种减少节点增减时缓存失效的算法。在Nginx中，使用 `hash` 指令并添加 `consistent` 参数配置：
```nginx
hash $request_uri consistent;
```

### 5. 如何配置备份服务器？
**答案**：在 `upstream` 块中使用 `backup` 参数：
```nginx
server 192.168.1.102:8080 backup;
```
当所有主服务器不可用时，备份服务器会接管请求。

### 6. Nginx的最少连接算法支持权重吗？
**答案**：支持。从Nginx 1.3.14版本开始，`least_conn` 可以与 `weight` 参数结合使用，实现加权最少连接算法。

### 7. URL哈希和IP哈希的适用场景有什么不同？
**答案**：
- URL哈希：适用于需要缓存一致性的场景，如静态资源服务器
- IP哈希：适用于需要会话保持的场景，如用户登录状态管理

### 8. 如何在Nginx中禁用某台后端服务器？
**答案**：在 `upstream` 块中使用 `down` 参数：
```nginx
server 192.168.1.103:8080 down;
```
这样Nginx会暂时跳过该服务器，不会将请求分配给它。