---
date: 2025-07-01
author: Gaaming Zhang
category:
  - Redis
tag:
  - Redis
  - 还在施工中
---

# redis集群模式

## 详细解答
Redis 常见集群形态：
- **主从+哨兵**：
  - 架构：1主N从，哨兵集群监控主从状态
  - 功能：实现读写分离和自动主从切换
  - 适用场景：小规模应用、数据量≤50GB、无水平分片需求
  - 优缺点：部署简单，无需客户端改造；但不支持水平扩展，单主节点瓶颈明显

- **Redis Cluster（官方分片）**：
  - 架构：去中心化设计，节点互为对等，16384 哈希槽分片
  - 功能：客户端感知槽分布并跟随 MOVED/ASK 重定向，主从架构容忍节点故障
  - 适用场景：中大型应用、数据量＞50GB、需要水平扩展
  - 优缺点：原生支持分片和高可用，性能优秀；但客户端需支持 Cluster 协议，多键操作需特殊处理

- **代理模式（如 Twemproxy、Codis）**：
  - 架构：客户端→代理层→Redis 节点
  - 功能：客户端无感知分片，代理层维护路由
  - 适用场景：已有客户端不支持 Cluster 协议、需要兼容性
  - 优缺点：客户端无需改造，运维简单；但多一跳网络延迟，代理可能成为性能瓶颈

### 核心机制详解
1. **数据分片机制**：
   - 槽分配算法：`slot = CRC16(key) % 16384`
   - 槽迁移：支持运行时动态调整槽分布，迁移过程中使用ASK重定向
   - hash tag：通过`{tag}key`语法确保相关键落在同一槽位
   - 槽信息传播：节点通过Gossip协议同步槽分布信息

2. **高可用机制**：
   - 故障检测：节点间通过PING/PONG心跳检测状态（默认每秒10次）
   - 故障确认：需要大多数主节点（≥N/2+1）确认故障
   - 故障转移：
     - 从节点发起选举请求
     - 主节点投票选出新主（需≥N/2+1票）
     - 新主接管槽位并广播集群变更
   - 配置纪元：每个主节点有唯一配置纪元，选举时优先选择配置纪元最高的节点

3. **一致性与写安全**：
   - 一致性保证：最终一致性，主从异步复制有数据丢失风险
   - 写安全配置：
     ```redis
     min-replicas-to-write 1  # 至少需要1个从节点
     min-replicas-max-lag 10  # 从节点复制延迟不超过10秒
     ```
   - 事务支持：仅支持单节点内的MULTI/EXEC事务和Lua脚本
   - 跨键操作：跨槽多键操作会失败，需使用hash tag保证同槽

4. **持久化与恢复**：
   - 持久化策略：支持AOF（everysec/always/no）和RDB
   - 恢复流程：
     - 节点重启先加载本地持久化文件
     - 与主节点进行增量数据同步
     - 完成后加入集群开始服务
   - 增量同步：通过复制偏移量和积压缓冲区实现

### 运维要点
1. **扩容/缩容**：
   - 扩容步骤：启动新节点→加入集群→迁移槽位→均衡槽分布
   - 缩容步骤：迁移槽位→移除节点→更新配置
   - 工具：`redis-cli --cluster add-node`/`reshard`/`del-node`

2. **读写路径优化**：
   - 写操作：必须走主节点
   - 读操作：可走主节点或只读从节点（`slave-read-only yes`）
   - 读写分离：通过客户端实现，注意从节点数据延迟

3. **性能优化**：
   - 避免大Key/热Key：大Key影响迁移和复制，热Key导致节点过载
   - Pipeline批量操作：减少网络往返，提升吞吐量
   - 连接池管理：客户端实现高效的连接池，避免频繁创建连接

4. **监控与告警**：
   - 核心指标：槽覆盖、节点状态、内存使用、复制延迟、QPS/延迟
   - 告警阈值：内存使用率＞80%、复制延迟＞1秒、节点下线
   - 监控工具：Redis Exporter + Prometheus + Grafana

5. **常见问题与解决方案**：
   - 槽分布不均：使用`redis-cli --cluster rebalance`重新均衡槽位
   - 大Key处理：拆分大Key或使用Hash结构存储
   - 网络分区：通过`cluster-node-timeout`控制分区检测时间
   - 内存碎片：定期重启节点或使用`memory purge`命令清理

## 高频追问与简答
- 问：Redis Cluster 如何做故障转移？
	答：节点间心跳标记主为 FAIL，大多数主确认后由其从节点发起选举，满足配置纪元最大且日志最新的从提升为主；客户端收到 MOVED 更新路由。

- 问：MOVED 与 ASK 区别？
	答：MOVED 表示槽已永久迁到新节点，客户端刷新槽映射；ASK 表示槽迁移进行中，本次请求临时重定向且需带 ASKING 命令。

- 问：为何不支持跨槽事务？怎么处理多键操作？
	答：分片后不同槽在不同节点，原子性无法保障；通过 hash tag 将相关键放同槽，或在业务侧拆分。

- 问：如何避免主从不一致导致的数据丢失？
	答：设置 min-replicas-to-write/min-replicas-max-lag，主在从节点不足或延迟过高时拒写；关键链路开启 AOF everysec 或增量备份。

- 问：扩容时如何保证可用？
	答：先添加节点作为从，进行槽迁移（reshard），迁移采用小批量 Key，业务端需支持 ASK；迁移完成后再做主从角色调整。

- 问：Codis 与官方 Cluster 的主要差异？
	答：Codis 通过代理屏蔽分片，迁移平滑、客户端无感；但多一跳、单点需 HA；官方 Cluster 去中心化、无代理，客户端需实现路由。

- 问：Redis Cluster 的 Gossip 协议有什么作用？
	答：Gossip 协议用于节点间传播集群信息，包括节点状态、槽分布、故障信息等；通过 PING/PONG 消息实现节点发现和故障检测；每个节点维护一个集群视图，定期与其他节点交换信息。

- 问：如何设置 Redis Cluster 的副本因子？
	答：副本因子指每个主节点的从节点数量，通用业务场景设置为 1（1主1从），核心业务场景设置为 2（1主2从）；通过 `CLUSTER REPLICATE <master-node-id>` 命令将从节点关联到主节点。

- 问：Redis Cluster 支持读写分离吗？如何实现？
	答：支持，读操作可路由到从节点；客户端需实现读写分离逻辑，写操作发送到主节点，读操作可根据策略发送到主节点或从节点；注意从节点数据延迟问题，可通过监控复制偏移量控制延迟。

- 问：如何监控 Redis Cluster 的健康状态？
	答：监控核心指标包括槽覆盖、节点状态、内存使用、复制延迟、QPS/延迟等；使用 Redis Exporter + Prometheus + Grafana 搭建监控系统；设置告警阈值，如内存使用率＞80%、复制延迟＞1秒、节点下线等。

### 哈希槽主从全挂的故障转移
在 Redis Cluster 中，故障转移依赖“主从复制+投票”。如果某个哈希槽对应的主节点及其所有从节点全部宕机，集群无法自动提升新主，因为不存在可选的从节点副本。这时集群会进入“槽未覆盖”状态：默认配置下返回 `CLUSTERDOWN Hash slot not served`，如果 `cluster-require-full-coverage no` 则仅该槽不可用，其他槽照常服务。恢复路径通常是：
- 紧急止血：将 `cluster-require-full-coverage` 设为 `no`，保证其他业务不被波及；客户端需容错该槽的请求。
- 数据恢复：基于最近的 AOF/RDB 备份启动一个新节点，或新增空节点接受该槽并接受数据丢失的风险。
- 槽重分配：使用 `redis-cli --cluster reshard` 将该槽（及必要的 key）迁移到健康主节点，或把新节点加入为该槽的主；随后为其再添加至少 1 个从节点，恢复高可用。
- 事后治理：增加每主最少从节点数、开启跨机架副本、监控坏盘/延迟、定期演练恢复，减少“主从同时故障”的概率。

## 相关高频面试题
- 问：`cluster-require-full-coverage` 的作用是什么？
	答：为 `yes` 时任何槽未覆盖即集群整体不可用；为 `no` 时仅未覆盖的槽不可用，已覆盖的槽继续服务，适合降级运行。

- 问：当客户端访问未覆盖槽时会看到什么？
	答：返回 `CLUSTERDOWN Hash slot not served`，调用方应降级或重试不同资源；若处于迁移中可能收到 `ASK`，需加 `ASKING` 后临时重定向。

- 问：没有从节点时还能自动故障转移吗？
	答：不能。故障转移必须有可提升的副本；否则只能通过备份恢复或手工 `reshard` 迁槽到健康主。

- 问：如何降低“主从同时宕机”的风险？
	答：每主至少 2 个从，跨机架/跨可用区部署；设置 `min-replicas-to-write` 与最大复制延迟限制；监控磁盘 SMART 与节点心跳，及时下线风险主机。

- 问：手工恢复的标准流程是什么？
	答：新节点加入集群→为其分配故障槽→从备份加载（或接受空槽）→建立至少 1 个从→校验槽覆盖与副本健康→恢复流量并观测。

- 问：Redis Cluster 支持的最大节点数是多少？
	答：理论上无限制，但受限于实际硬件资源和网络性能；推荐主节点数不超过1000个，避免Gossip协议传播延迟过高。

- 问：如何处理 Redis Cluster 中的热点槽？
	答：热点槽通常由热Key导致；解决方案包括：拆分热Key为多个子Key、使用本地缓存减少Redis访问、使用hash tag将热Key分散到不同槽位、增加热点槽所在节点的从节点分担读压力。

- 问：Redis Cluster 的配置纪元是什么？有什么作用？
	答：配置纪元是一个单调递增的计数器，用于标识集群的配置版本；每个主节点有唯一的配置纪元；在故障转移时，从节点会使用更高的配置纪元，确保新主节点的权威性。

- 问：如何在 Redis Cluster 中使用 Lua 脚本？
	答：支持在单节点内执行 Lua 脚本；脚本中操作的所有键必须属于同一槽位；可使用 hash tag 确保键落在同一槽位；脚本执行期间会阻塞整个节点，避免执行长时间运行的脚本。

- 问：Redis Cluster 与单机 Redis 的性能对比如何？
	答：在相同硬件条件下，Redis Cluster 的单节点性能与单机 Redis 相近；集群整体性能随节点数量线性增长，但受限于网络带宽和客户端实现；多键操作和跨槽操作会带来额外开销。