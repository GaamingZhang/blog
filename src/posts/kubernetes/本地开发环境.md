# Kubernetes 本地开发环境

## 为什么需要本地 Kubernetes 环境？

学习 Kubernetes 或者开发云原生应用时，你需要一个可以随意折腾的集群。但真正的 Kubernetes 集群通常运行在云上，需要付费且操作有风险。

本地 Kubernetes 环境就是解决这个问题的。它让你在自己的电脑上运行一个"迷你版"的 Kubernetes 集群，可以：

- **学习和实验**：不怕搞坏，随时重建
- **开发和调试**：本地开发应用，直接部署到 K8s 测试
- **CI/CD 测试**：在流水线中快速启动集群进行测试

就像你学开车不会直接上高速，本地 K8s 环境就是你的"练车场"。

## 三个主流工具

目前最常用的本地 Kubernetes 工具有三个，它们各有特点：

### Minikube：最适合学习

Minikube 是 Kubernetes 官方维护的工具，历史最悠久，文档最完善。它通过虚拟机或 Docker 在本地运行一个单节点集群。

**优点**：
- 功能完整，最接近真实集群
- 插件丰富，一键启用 Ingress、Dashboard 等
- 文档和社区支持好

**缺点**：
- 启动相对较慢
- 资源占用稍大

**适合场景**：初学者学习 Kubernetes

### Kind：最适合 CI/CD

Kind（Kubernetes in Docker）把 Kubernetes 集群运行在 Docker 容器里。每个节点就是一个 Docker 容器。

**优点**：
- 启动非常快
- 资源占用小
- 原生支持多节点集群
- 很容易在 CI/CD 中使用

**缺点**：
- 某些功能（如 LoadBalancer）需要额外配置

**适合场景**：CI/CD 流水线、需要多节点测试

### k3s/k3d：最轻量

k3s 是 Rancher 开发的轻量级 Kubernetes 发行版，专为资源受限环境设计。k3d 则是在 Docker 中运行 k3s 的工具。

**优点**：
- 极其轻量，启动快
- 单个二进制文件，安装简单
- 也可用于生产环境（边缘计算、IoT）

**缺点**：
- 某些高级功能被简化或移除

**适合场景**：资源受限的开发机、边缘计算开发

## 如何选择？

简单的选择建议：

- **刚开始学 Kubernetes** → Minikube，功能完整，文档好
- **已经熟悉 K8s，想快速测试** → Kind，启动快、占资源少
- **电脑配置不高** → k3d，最轻量
- **做 CI/CD 集成** → Kind 或 k3d，容易自动化

实际上，这三个工具的基本操作都差不多，学会一个后切换到另一个很容易。

## 快速开始

### Minikube

```bash
# 安装（macOS）
brew install minikube

# 启动集群
minikube start

# 查看状态
minikube status

# 启用常用插件
minikube addons enable ingress
minikube addons enable dashboard

# 打开 Dashboard
minikube dashboard

# 停止集群（保留数据）
minikube stop

# 删除集群（清除所有）
minikube delete
```

### Kind

```bash
# 安装（macOS）
brew install kind

# 创建集群
kind create cluster

# 查看集群
kind get clusters

# 删除集群
kind delete cluster
```

### k3d

```bash
# 安装
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

# 创建集群
k3d cluster create my-cluster

# 删除集群
k3d cluster delete my-cluster
```

## 本地开发中的镜像问题

在本地开发时，你构建的镜像在本地 Docker 中，但 Kubernetes 集群可能"看不到"这些镜像。这是因为集群运行在独立的环境中。

解决方案因工具而异：

### Minikube 方案

让 Minikube 和你的 Docker 共享环境：

```bash
# 设置 Docker 环境变量
eval $(minikube docker-env)

# 现在构建的镜像直接在 Minikube 内
docker build -t myapp:local .
```

记得在 Pod 中设置 `imagePullPolicy: Never`，告诉 K8s 不要去远程拉取。

### Kind 方案

把镜像"加载"到 Kind 集群：

```bash
# 本地构建
docker build -t myapp:local .

# 加载到 Kind
kind load docker-image myapp:local
```

### k3d 方案

类似 Kind：

```bash
docker build -t myapp:local .
k3d image import myapp:local -c my-cluster
```

## 访问集群中的服务

本地开发时，你需要从浏览器或命令行访问集群中运行的服务。

### 端口转发（通用方法）

最简单的方式，适用于所有工具：

```bash
kubectl port-forward svc/myservice 8080:80
# 然后访问 http://localhost:8080
```

### Minikube 服务命令

Minikube 提供了便捷命令：

```bash
# 获取服务的可访问 URL
minikube service myservice --url

# 直接在浏览器打开
minikube service myservice
```

### 配置端口映射

在创建集群时就配置端口映射，之后直接访问 localhost：

```bash
# k3d 示例
k3d cluster create my-cluster -p "8080:80@loadbalancer"

# 之后访问 http://localhost:8080 就能到达集群的 80 端口
```

## 开发工作流建议

一个高效的本地开发流程：

1. **启动集群**：使用上述工具之一
2. **构建镜像**：修改代码后构建新镜像
3. **加载镜像**：把镜像加载到集群
4. **部署应用**：使用 kubectl 或 Helm 部署
5. **测试验证**：通过端口转发访问服务
6. **迭代**：修改代码，重复 2-5

如果觉得手动操作太繁琐，可以使用 Skaffold 或 Tilt 等工具自动化这个流程。它们会监听文件变化，自动完成构建、加载、部署的过程。

## 常见问题

### Q1: 集群启动失败怎么办？

首先检查日志：

- **Minikube**：`minikube logs`
- **Kind**：`docker logs kind-control-plane`
- **k3s**：`journalctl -u k3s`

常见原因：
- Docker 没有运行
- 资源不足（给 Docker 分配更多 CPU/内存）
- 端口被占用

### Q2: 为什么 Pod 拉取不到我本地的镜像？

Kubernetes 默认会尝试从远程仓库拉取镜像。对于本地开发：

1. 确保镜像已经加载到集群（见上面的镜像问题部分）
2. 在 Pod 配置中设置 `imagePullPolicy: Never` 或 `IfNotPresent`
3. 镜像标签避免使用 `latest`（它默认总是尝试拉取）

### Q3: 如何模拟多节点集群？

有时候需要测试节点故障、Pod 调度等场景。Kind 和 k3d 都支持多节点：

```bash
# Kind：使用配置文件
# k3d：使用命令行参数
k3d cluster create my-cluster --servers 1 --agents 3
```

Minikube 也支持：`minikube start --nodes=3`

### Q4: 集群占用太多资源怎么办？

几个建议：

1. **用完就停**：`minikube stop` / `kind delete cluster`
2. **限制资源**：启动时指定 CPU 和内存限制
3. **选择轻量工具**：k3d 比 Minikube 占用资源少
4. **清理 Docker**：`docker system prune -a` 清理无用镜像

### Q5: 本地开发和生产环境差异大怎么办？

本地环境毕竟是模拟的，和生产环境会有差异。几个建议：

1. **使用相同的部署方式**：本地和生产都用 Helm Chart
2. **配置资源限制**：即使在本地也设置 resources，提前发现问题
3. **使用多节点测试**：验证 Pod 调度行为
4. **测试失败场景**：手动删除 Pod，看服务是否能恢复

记住，本地环境的目的是快速迭代和基本验证，复杂的场景还是需要在更接近生产的环境中测试。

## 总结

本地 Kubernetes 环境让你可以在自己的电脑上学习和开发，不需要昂贵的云资源。

- **Minikube** 功能完整，最适合学习
- **Kind** 启动快，最适合 CI/CD
- **k3d** 最轻量，适合资源受限场景

选择哪个工具不是最重要的，重要的是开始动手实践。这三个工具的核心概念是相通的，掌握一个后切换到另一个很容易。
