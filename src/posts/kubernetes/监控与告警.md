---
date: 2026-01-30
author: Gaaming Zhang
isOriginal: true
article: true
category:
  - Kubernetes
tag:
  - Kubernetes
  - ClaudeCode
---

# Kubernetes 监控与告警

## 为什么监控很重要？

想象一下，你开了一家餐厅，但你不知道每天有多少客人、厨房的炉灶温度是否正常、食材还剩多少。这样经营餐厅是很危险的 —— 你可能在客流高峰时人手不足，或者在炉灶过热时才发现问题。

监控系统就是你的"餐厅仪表盘"，它告诉你：
- **现在发生了什么**：CPU用了多少、内存够不够、有多少请求
- **是否出了问题**：服务是否健康、响应是否变慢
- **趋势如何**：资源使用是在增长还是稳定

而告警系统则是当指标异常时，主动通知你"炉灶快过热了"，而不是等到着火了才发现。

## 监控的层次

在 Kubernetes 环境中，监控需要覆盖多个层次：

1. **节点层**：服务器的 CPU、内存、磁盘、网络
2. **Kubernetes 层**：Pod 状态、Deployment 副本数、资源配额
3. **应用层**：请求数、响应时间、错误率

就像监控餐厅，你既要关心厨房设备（节点），也要关心后厨流程（Kubernetes），还要关心菜品质量（应用）。

## Prometheus：云原生监控的标准

Prometheus 是 Kubernetes 生态中最流行的监控工具，它有几个核心概念：

### 拉取模式

与传统监控不同，Prometheus 采用**拉取（Pull）模式**：它主动去各个服务拉取指标，而不是等服务推送。

这样做的好处是：
- Prometheus 知道谁挂了（拉取失败）
- 服务不需要知道监控系统在哪里
- 统一的采集频率，数据更规整

### 指标格式

Prometheus 的指标是简单的文本格式：

```
http_requests_total{method="GET", status="200"} 1234
http_requests_total{method="POST", status="500"} 56
```

每个指标有名字、标签和值。标签让你可以按各种维度筛选和聚合。

### 四种指标类型

- **Counter（计数器）**：只增不减，如请求总数
- **Gauge（仪表盘）**：可增可减，如当前内存使用量
- **Histogram（直方图）**：统计分布，如响应时间分布
- **Summary（摘要）**：类似直方图，但在客户端计算

## 监控体系的组成

一个完整的监控体系通常包括：

### Prometheus

核心组件，负责采集和存储指标数据。它定期从各个目标拉取指标，存储在本地的时序数据库中。

### Grafana

可视化工具，把 Prometheus 的数据变成图表和仪表盘。让你一眼就能看到系统状态。

### Alertmanager

告警管理器，当指标触发告警规则时，它负责发送通知（邮件、Slack、钉钉等），还能对告警进行分组、去重、静默等处理。

### 各种 Exporter

负责暴露指标的组件：
- **Node Exporter**：暴露节点的 CPU、内存、磁盘等指标
- **kube-state-metrics**：暴露 Kubernetes 对象的状态（Pod、Deployment 等）

## 如何让 Prometheus 发现监控目标？

在 Kubernetes 中，Pod 会动态创建和销毁，Prometheus 如何知道该监控谁呢？答案是 **ServiceMonitor**。

ServiceMonitor 是 Prometheus Operator 提供的一种资源，它告诉 Prometheus：

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: web-app-monitor
spec:
  selector:
    matchLabels:
      app: web-app         # 监控所有带这个标签的 Service
  endpoints:
    - port: metrics        # 从 metrics 端口采集
      interval: 15s        # 每15秒采集一次
```

这样，只要你的 Service 有 `app: web-app` 标签，Prometheus 就会自动发现并开始监控。

## 关键指标有哪些？

### 节点健康

节点是否正常运行？CPU 和内存是否够用？

```
# CPU使用率超过85%可能需要关注
# 内存使用率超过90%需要警惕
# 磁盘使用率超过85%应该清理或扩容
```

### Pod 状态

Pod 是否在正常运行？有没有频繁重启？

```
# Pod重启次数突然增加，说明可能有问题
# Pod一直处于Pending状态，可能是资源不足
```

### 应用性能

请求响应是否正常？错误率是否增加？

```
# 请求延迟突然增加，需要排查
# 5xx错误率上升，说明服务有问题
```

## 告警规则的设计

好的告警规则应该：

1. **有明确的阈值**：不是"CPU高"，而是"CPU超过85%持续10分钟"
2. **有持续时间要求**：避免瞬时波动触发告警
3. **有合理的严重级别**：critical（紧急）vs warning（警告）
4. **有清晰的描述**：告诉值班人员发生了什么、影响是什么

一个典型的告警规则：

```yaml
- alert: PodCrashLooping
  expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
  for: 5m                    # 持续5分钟才告警
  labels:
    severity: warning        # 严重级别
  annotations:
    summary: "Pod 在频繁重启"
    description: "Pod {{ $labels.pod }} 在过去15分钟内发生了重启"
```

## 告警通知的处理

Alertmanager 不只是发通知，它还有一些智能处理：

### 分组

把相关的告警合并成一条通知。比如一个节点挂了导致10个 Pod 重启，你不希望收到10条通知。

### 抑制

当严重问题发生时，抑制由它引发的次要告警。比如节点宕机时，不需要再告诉你这个节点上的 Pod 不健康了。

### 静默

临时屏蔽某些告警。比如计划内的维护期间，可以静默相关告警。

## 如何快速开始？

最简单的方式是使用 Helm 安装 kube-prometheus-stack：

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace
```

这会一次性安装 Prometheus、Grafana、Alertmanager 和常用的 Exporter，还附带了一套预配置的告警规则和 Dashboard。

## 常见问题

### Q1: Prometheus 显示某个目标是 DOWN 怎么办？

这通常意味着 Prometheus 无法从目标采集指标，原因可能是：

1. **服务没有暴露 /metrics 端点**：检查你的应用是否在指定端口暴露了 Prometheus 格式的指标
2. **网络不通**：检查 Service 和 Endpoints 是否正确配置
3. **端口配置错误**：ServiceMonitor 中配置的端口名称要和 Service 中定义的一致

排查思路：先确认服务本身能访问，再检查 Prometheus 的配置。

### Q2: 告警太多太吵怎么办？

告警疲劳是真实存在的问题，几个建议：

1. **调高阈值和持续时间**：避免瞬时波动触发告警
2. **合理设置严重级别**：只有真正紧急的才发短信/电话，其他的发邮件或 Slack 即可
3. **使用抑制规则**：让严重问题抑制次要问题
4. **定期审查告警规则**：没人响应的告警要么调优，要么删除

记住：如果每条告警都是紧急的，那就没有告警是紧急的。

### Q3: Prometheus 磁盘满了怎么办？

Prometheus 把数据存储在本地磁盘，时间久了自然会满。解决方案：

1. **缩短数据保留时间**：比如从 30 天改成 15 天
2. **扩容存储**：增加 PVC 的大小
3. **降低采集频率**：某些不那么重要的指标可以降低采集频率

对于长期存储需求，可以考虑使用 Thanos 或 VictoriaMetrics 等方案。

### Q4: 如何监控 Kubernetes 集群外的服务？

比如你有一个外部的 MySQL 数据库想纳入监控。可以通过创建一个 Endpoints 资源，手动指定外部服务的地址：

```yaml
apiVersion: v1
kind: Endpoints
metadata:
  name: external-mysql
subsets:
  - addresses:
      - ip: 192.168.1.100   # 外部服务的IP
    ports:
      - port: 9104          # MySQL Exporter的端口
```

然后再创建对应的 Service 和 ServiceMonitor。

### Q5: 如何让应用暴露指标？

大多数语言都有 Prometheus 客户端库。基本思路是：

1. 引入 Prometheus 客户端库
2. 定义你关心的指标（请求数、延迟等）
3. 在代码中更新指标值
4. 暴露一个 /metrics 端点

然后配置 ServiceMonitor 让 Prometheus 来采集就可以了。

## 总结

监控和告警是运维 Kubernetes 集群的基础设施。好的监控让你对系统状态了然于胸，好的告警让你能及时发现和响应问题。

记住几个原则：
- 监控要全面：节点、Kubernetes、应用都要覆盖
- 告警要精准：宁缺毋滥，每条告警都要有人响应
- 可视化要清晰：一眼能看出问题所在
