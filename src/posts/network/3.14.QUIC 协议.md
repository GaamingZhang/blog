# QUIC 协议

#### 核心概念

**QUIC（Quick UDP Internet Connections）** 是基于 UDP 的传输层协议，由 Google 提出，现为 IETF 标准。它集成 **传输 + 加密 + 多路复用 + 连接迁移**，目标是在弱网和移动场景下显著降低时延、避免 TCP 队头阻塞。

**关键特性**：
- 基于 UDP：用户态实现，部署无需内核升级。
- 内置 TLS 1.3：握手与密钥协商合并，0-RTT/1-RTT 建连。
- 多路复用：流级别（stream）独立，无 TCP 队头阻塞。
- 连接迁移：使用 Connection ID，IP/端口变更不中断。
- 拥塞控制可插拔：可用 BBR/CUBIC/自定义实现。

---

#### 握手与加密

- **1-RTT**：客户端初次与服务器完成握手、协商密钥、建立连接。
- **0-RTT**：重连时可用之前的会话票据发 0-RTT 数据，降低首包时延（有重放风险，需幂等）。
- 所有报文均加密（含握手后头部大部分字段），减少中间人篡改机会。

---

#### 多路复用与队头阻塞

- QUIC 在连接内提供多个 **Stream**，各自有序、独立流控；单个流的丢包只阻塞该流，不影响其他流，避免 TCP 层队头阻塞。
- 仍需注意 **应用层队头阻塞**：同一 HTTP/3 请求内部的帧顺序仍要保证。

---

#### 连接迁移与可靠性

- **Connection ID（CID）**：标识连接而非依赖四元组，移动网络切换（如 4G→Wi-Fi）无需重建连接。
- **包序号空间独立**：初始、握手、应用数据各用独立包号空间，简化重传判定。
- **重传与流控**：基于 ACK Frame、最大数据/最大流量窗口，拥塞控制算法可替换。

---

#### 性能优势与代价

- 优势：减少握手 RTT；避免 TCP 队头阻塞；连接迁移改善移动体验；用户态可快速迭代算法。
- 代价：中间盒兼容性（老式防火墙/限 UDP 环境）；用户态实现 CPU 开销高；0-RTT 需防重放。

---

#### 常见排查要点

1) 确认链路：防火墙/网关是否放行 UDP 443；抓包用 `tcpdump -i eth0 udp port 443`。
2) 协商版本：HTTP/3/QUIC 版本不一致会降级；浏览器 `chrome://net-export` 查看。
3) 观测指标：握手 RTT、0-RTT 命中率、丢包率、重传率、CID 迁移成功率。
4) 回退策略：失败时优雅降级到 HTTP/2（TCP+TLS）。

---

### 相关高频面试题

**Q1: QUIC 相比 HTTP/2 (TCP+TLS) 的主要改进？**
- 传输层即支持多路复用，无 TCP 队头阻塞；0-RTT/1-RTT 握手更快；CID 支持连接迁移；用户态拥塞/流控可快速演进。

**Q2: 0-RTT 的风险与适用场景？**
- 风险：重放攻击（数据可能被重复）；需确保请求幂等且无副作用。
- 适用：GET/HEAD/查询类接口；不适用转账、下单等非幂等操作。

**Q3: QUIC 如何避免队头阻塞？**
- 将多请求拆分为独立 Stream，各自独立确认和重传；某流丢包不阻塞其他流，区别于 TCP 的单字节流。

**Q4: 连接迁移如何实现？**
- 使用 CID 标识连接，四元组变化时通过 PATH CHALLENGE/PATH RESPONSE 验证新路径可达，迁移后继续复用同一连接与密钥。

**Q5: QUIC 的拥塞控制可以替换吗？**
- 可以。协议开放 CC/流控接口，常见实现有 BBR、CUBIC；服务端可按场景自定义算法迭代。

**Q6: 为什么有些场景仍需回退到 TCP？**
- 网络或中间盒限制 UDP；老旧设备不识别 QUIC 封装；企业内网策略屏蔽 UDP 443。这类情况下需降级 HTTP/2/1.1 保证可用性。
