# HTTP 协议

#### 核心概念

**HTTP（HyperText Transfer Protocol）** 是应用层无状态、基于请求-响应的协议，运行在 TCP（或 TLS）之上。它定义了浏览器与服务器如何交换数据，常见版本有 **HTTP/1.1、HTTP/2、HTTP/3**。

**关键特性**：
- 无状态：一次请求完成后不保留会话状态（可用 Cookie/Session/Token 补充）
- 灵活：方法、头、URI 均为文本，易扩展
- 可缓存：通过 Cache-Control/ETag 等头减少重复请求
- 可协商：支持内容协商（语言、编码、媒体类型）

---

#### 请求与响应报文结构

**请求行**：`METHOD URI HTTP/version`
- 常用方法：GET（读）、POST（提交）、PUT/PATCH（更新）、DELETE（删除）、HEAD（仅头）、OPTIONS（探测）、CONNECT（隧道）

**请求头**：
- 常见：Host、User-Agent、Accept、Accept-Language、Accept-Encoding、Content-Type、Content-Length、Authorization、Cookie
- 缓存相关：Cache-Control、If-None-Match、If-Modified-Since
- 连接相关：Connection、Upgrade、Range

**响应行**：`HTTP/version status reason`
- 常见状态码：
	- 1xx：信息（100 Continue）
	- 2xx：成功（200 OK、201 Created、204 No Content）
	- 3xx：重定向（301/302/307/308，304 Not Modified）
	- 4xx：客户端错误（400、401、403、404、429）
	- 5xx：服务器错误（500、502、503、504）

**响应头**：
- 缓存：Cache-Control、ETag、Last-Modified, Expires
- 安全：Set-Cookie、Strict-Transport-Security、Content-Security-Policy、X-Frame-Options
- 传输：Content-Type、Content-Length、Transfer-Encoding、Content-Encoding

---

#### 版本演进要点

- **HTTP/1.1**：持久连接（Keep-Alive）、管线化（但受限于队头阻塞）、分块传输编码（chunked）。
- **HTTP/2**：二进制分帧、多路复用、首部压缩（HPACK）、服务端推送（实践中多禁用）。解决了队头阻塞（TCP 层仍有）。
- **HTTP/3**：基于 QUIC（UDP），内置 TLS 1.3，连接迁移，彻底消除 TCP 队头阻塞，握手更快。

---

#### 缓存与协商

强缓存：`Cache-Control: max-age=3600` 或 `Expires`；命中则直接使用缓存。

协商缓存：
- ETag / If-None-Match（推荐，基于内容哈希）
- Last-Modified / If-Modified-Since（基于时间，精度秒）
命中协商缓存返回 304，节省带宽。

---

#### 长连接与并发

- HTTP/1.1 默认 Keep-Alive，同一 TCP 连接可复用多个请求；但队头阻塞导致通常需并发多连接。
- HTTP/2/3 支持单连接多路复用，减少连接数与握手成本。

---

#### 常用头实践速查

- 压缩：`Accept-Encoding: gzip, br`；响应 `Content-Encoding: gzip/br`
- 传输：大文件用 `Range`/`206 Partial Content` 断点续传；流式用 `Transfer-Encoding: chunked`
- 重定向：301/308（永久），302/307（临时保持方法），携带 `Location`
- 安全：`HSTS`（Strict-Transport-Security），`CSP`，`SameSite`/`HttpOnly`/`Secure` Cookie

---

#### 排查思路（简版）

1) 看 DNS/IP：`ping/nslookup/dig` 确认解析；`curl -v` 看握手。
2) 看状态码：4xx 多为客户端/鉴权；5xx 多为服务端。
3) 看缓存：是否被 304/缓存命中；是否缓存过期。
4) 看链路：`curl -v --http2 --resolve host:443:ip` 直连后端绕过域名。
5) 看延迟：`curl -w "%{time_connect} %{time_starttransfer} %{time_total}"`。

---

### 相关高频面试题

**Q1: HTTP/1.1 队头阻塞是什么，如何缓解？**
- HTTP/1.1 同一连接串行处理请求，前一个响应未返回时后续阻塞。
- 缓解：开启多连接并发；升级 HTTP/2/3；拆分资源、使用 CDN；减少巨型响应。

**Q2: 301/302/307/308 的区别？**
- 301/308 永久重定向；302/307 临时重定向。
- 301/302 早期会改写方法为 GET；307/308 严格保留原方法和请求体。

**Q3: 强缓存与协商缓存的区别？**
- 强缓存命中直接用本地副本（返回 200 from cache，不访问服务器）。
- 协商缓存需带 If-None-Match/If-Modified-Since，与服务器确认，命中返回 304。

**Q4: HTTP/2 相对 HTTP/1.1 的核心改进？**
- 二进制分帧、多路复用、头部压缩（HPACK）、优先级与流量控制、可选服务端推送。

**Q5: HTTP/3 为何能减少握手延迟？**
- 基于 QUIC/UDP，集成 TLS 1.3，首个 RTT 内完成加密握手；连接 ID 支持网络切换快速迁移；无 TCP 队头阻塞。

**Q6: Cookie 与 Token 的主要差异？**
- Cookie 由浏览器自动携带，易受 CSRF，需要 SameSite/HttpOnly/Secure；
- Token（如 JWT）通常放在 Authorization 头，跨域友好，需关注过期与签名校验，避免存储在可被脚本读取的场所。