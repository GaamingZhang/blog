---
date: 2026-01-15
author: Gaaming Zhang
isOriginal: true
article: true
category:
  - 数据库
tag:
  - 数据库
---

# MySQL的索引的数据结构

## 一、索引的基本概念和作用

### 1. 索引的定义

索引（Index）是一种数据结构，用于快速查找数据库表中的特定记录。它类似于书籍的目录，可以帮助数据库管理系统（DBMS）快速定位和访问表中的数据，而无需扫描整个表。

### 2. 索引的作用

- **提高查询速度**：通过索引，MySQL可以直接定位到符合条件的记录，避免全表扫描
- **加速排序和分组**：索引通常是有序的，可以加速ORDER BY和GROUP BY操作
- **保证数据完整性**：唯一索引可以确保列或列组合的值唯一
- **减少磁盘I/O**：通过索引减少需要读取的数据量，提高查询效率

### 3. 索引的代价

- **存储空间**：索引需要额外的存储空间
- **插入/更新/删除开销**：修改表数据时，需要同时更新索引
- **维护成本**：过多的索引会增加数据库的维护成本

### 4. 索引的设计原则

- **选择性原则**：选择区分度高的列作为索引
- **最左前缀原则**：复合索引中，索引的使用从左到右匹配
- **避免过度索引**：只在需要的列上创建索引
- **考虑查询模式**：根据实际的查询需求设计索引

## 二、MySQL的主要索引数据结构

### 1. B+树索引

B+树是MySQL中最常用的索引数据结构，几乎所有的存储引擎（如InnoDB、MyISAM）都支持B+树索引。

#### 1.1 B+树的基本结构

B+树是一种多路平衡查找树，具有以下特点：

- **树结构**：由根节点、中间节点和叶子节点组成
- **节点内容**：
  - 根节点和中间节点：只存储键值和指向子节点的指针
  - 叶子节点：存储键值和指向数据记录的指针（或直接存储数据记录）
- **平衡特性**：所有叶子节点都在同一层，树的高度较低
- **顺序链接**：叶子节点之间通过双向链表连接，便于范围查询

#### 1.2 B+树的查询过程

1. 从根节点开始，根据键值找到对应的子节点
2. 递归地在子节点中查找，直到到达叶子节点
3. 在叶子节点中找到对应的键值，获取指向数据记录的指针
4. 通过指针访问实际的数据记录

#### 1.3 B+树索引的特点

- **有序性**：索引中的键值是有序排列的
- **范围查询高效**：通过叶子节点的双向链表，可以快速进行范围查询
- **支持前缀匹配**：对于复合索引，支持最左前缀匹配
- **磁盘友好**：节点大小通常与磁盘页大小一致，减少磁盘I/O
- **适合大量数据**：树的高度较低，即使数据量大，查询效率也很高

### 2. 哈希索引

哈希索引基于哈希表实现，适用于精确匹配的查询场景。

#### 2.1 哈希索引的基本结构

- **哈希表**：由键值对组成的数据结构
- **哈希函数**：将索引键转换为哈希值
- **碰撞处理**：当两个不同的键产生相同的哈希值时，使用链表或开放寻址法处理

#### 2.2 哈希索引的查询过程

1. 对查询键应用哈希函数，得到哈希值
2. 根据哈希值定位到哈希表中的桶
3. 在桶中查找对应的键值对
4. 如果找到，返回指向数据记录的指针

#### 2.3 哈希索引的特点

- **精确匹配高效**：时间复杂度接近O(1)
- **不支持范围查询**：哈希值是无序的，无法进行范围查询
- **不支持前缀匹配**：无法利用复合索引的前缀进行查询
- **内存占用大**：需要存储所有键值的哈希值
- **碰撞影响性能**：碰撞过多会导致查询性能下降

### 3. 其他索引数据结构

#### 3.1 R树索引

R树索引主要用于空间数据类型（如GEOMETRY），支持空间查询（如查找某一区域内的点）。

#### 3.2 全文索引

全文索引用于全文搜索，通过倒排索引实现，可以快速查找包含特定词的文档。

#### 3.3 前缀索引

前缀索引是对列值的前缀建立的索引，可以减少索引的存储空间，但可能降低索引的选择性。

## 三、不同索引数据结构的优缺点分析

### 1. B+树索引

#### 1.1 优点

- **查询效率稳定**：无论是单点查询还是范围查询，效率都很高
- **范围查询高效**：通过叶子节点的双向链表，可以快速进行范围查询
- **排序操作高效**：索引本身是有序的，可以避免额外的排序操作
- **支持前缀匹配**：对于复合索引，支持最左前缀匹配
- **磁盘友好**：节点大小与磁盘页一致，减少磁盘I/O
- **适合大量数据**：树的高度较低，即使数据量大，查询效率也很高

#### 1.2 缺点

- **插入/更新/删除开销较大**：需要维护树的平衡
- **空间占用较大**：需要存储键值和指针
- **不适合精确匹配的简单查询**：相比哈希索引，精确匹配的效率稍低

#### 1.3 适用场景

- **范围查询**：如`WHERE age BETWEEN 20 AND 30`
- **排序操作**：如`ORDER BY id DESC`
- **分组操作**：如`GROUP BY department`
- **前缀匹配**：如`WHERE name LIKE '张%'`
- **复合条件查询**：如`WHERE age > 20 AND salary > 5000`

### 2. 哈希索引

#### 2.1 优点

- **精确匹配查询效率极高**：时间复杂度接近O(1)
- **插入/更新/删除操作简单**：哈希表的维护相对简单

#### 2.2 缺点

- **不支持范围查询**：无法进行`BETWEEN`、`>`, `<`等操作
- **不支持排序**：哈希值是无序的
- **不支持前缀匹配**：无法利用复合索引的前缀
- **碰撞影响性能**：当哈希碰撞较多时，查询效率会下降
- **内存占用大**：需要存储所有键值的哈希值

#### 2.3 适用场景

- **精确匹配查询**：如`WHERE id = 100`
- **简单查询**：没有复杂的条件组合
- **键值分布均匀**：避免哈希碰撞

### 3. 其他索引结构

#### 3.1 R树索引

- **优点**：支持空间查询，如查找某一区域内的点
- **缺点**：实现复杂，维护成本高
- **适用场景**：地理信息系统（GIS）应用，如地图服务

#### 3.2 全文索引

- **优点**：支持文本内容的全文搜索
- **缺点**：索引体积大，更新维护成本高
- **适用场景**：博客、新闻等需要文本搜索的应用

#### 3.3 前缀索引

- **优点**：减少索引的存储空间
- **缺点**：可能降低索引的选择性，影响查询效率
- **适用场景**：长字符串列，如URL、邮箱地址等

## 四、MySQL中不同类型的索引及其实现原理

### 1. 主键索引（Primary Key Index）

#### 1.1 定义和特点

主键索引是一种特殊的唯一索引，用于唯一标识表中的每一行记录。每个表只能有一个主键索引，主键列的值不能为NULL，且必须唯一。

#### 1.2 实现原理

在InnoDB存储引擎中，主键索引采用聚簇索引（Clustered Index）的方式实现：
- 数据行直接存储在主键索引的叶子节点中
- 主键索引的叶子节点包含了整行数据
- 主键索引的结构与B+树索引相同

在MyISAM存储引擎中，主键索引采用非聚簇索引的方式实现：
- 主键索引的叶子节点存储指向数据行的指针
- 数据行与索引分开存储

### 2. 唯一索引（Unique Index）

#### 2.1 定义和特点

唯一索引用于确保列或列组合的值唯一，但允许NULL值（最多一个NULL值）。一个表可以有多个唯一索引。

#### 2.2 实现原理

唯一索引的实现原理与普通B+树索引类似，但在插入或更新数据时，MySQL会检查索引列的值是否已存在。
- InnoDB存储引擎：唯一索引的叶子节点存储主键值（如果是辅助唯一索引）或指向数据行的指针（如果是独立唯一索引）
- MyISAM存储引擎：唯一索引的叶子节点存储指向数据行的指针

### 3. 普通索引（Normal Index）

#### 3.1 定义和特点

普通索引是最基本的索引类型，没有唯一性限制，也没有NOT NULL限制。一个表可以有多个普通索引。

#### 3.2 实现原理

普通索引采用B+树索引的方式实现：
- InnoDB存储引擎：普通索引的叶子节点存储主键值
- MyISAM存储引擎：普通索引的叶子节点存储指向数据行的指针

### 4. 复合索引（Composite Index）

#### 4.1 定义和特点

复合索引是基于多个列创建的索引，可以提高多列查询的效率。复合索引遵循最左前缀原则。

#### 4.2 实现原理

复合索引同样采用B+树索引的方式实现，但索引键由多个列的值组合而成：
- B+树的节点中存储复合索引的键值组合
- 叶子节点中存储指向数据行的指针（MyISAM）或主键值（InnoDB）
- 复合索引的排序是先按第一列排序，第一列相同的情况下按第二列排序，依此类推

### 5. 全文索引（Full-text Index）

#### 5.1 定义和特点

全文索引用于全文搜索，可以快速查找包含特定词或短语的文本数据。MySQL 5.6及以上版本的InnoDB存储引擎支持全文索引。

#### 5.2 实现原理

全文索引采用倒排索引（Inverted Index）的方式实现：
- 将文档拆分为单词（词项）
- 记录每个词项出现的文档ID和位置信息
- 支持布尔搜索、自然语言搜索等多种搜索方式

### 6. 空间索引（Spatial Index）

#### 6.1 定义和特点

空间索引用于空间数据类型（如GEOMETRY、POINT、LINESTRING、POLYGON等），支持空间查询（如查找某一区域内的点）。

#### 6.2 实现原理

空间索引采用R树或其变种的数据结构实现：
- 用于处理多维空间数据
- 支持空间包含、相交、距离等查询
- InnoDB和MyISAM存储引擎都支持空间索引

### 7. 前缀索引（Prefix Index）

#### 7.1 定义和特点

前缀索引是对列值的前缀部分建立的索引，可以减少索引的存储空间，适用于长字符串列。

#### 7.2 实现原理

前缀索引的实现原理与普通B+树索引类似，但只使用列值的前N个字符作为索引键：
- 可以减少索引的存储空间
- 可能降低索引的选择性
- 需要根据实际情况选择合适的前缀长度

### 8. 覆盖索引（Covering Index）

#### 8.1 定义和特点

覆盖索引是一种特殊的索引，索引包含了查询所需的所有列，无需回表查询数据行。

#### 8.2 实现原理

覆盖索引的实现原理与普通B+树索引相同，但索引键包含了查询所需的所有列：
- 查询只需要扫描索引，无需访问数据行
- 可以显著提高查询效率
- 减少磁盘I/O操作

### 9. 索引的使用原则

- 根据查询需求选择合适的索引类型
- 优先使用覆盖索引，减少回表操作
- 复合索引遵循最左前缀原则
- 避免在低选择性的列上创建索引
- 定期维护和优化索引

## 五、常见问题及答案

### 1. 为什么MySQL选择B+树作为主要的索引数据结构？

**答案：**

MySQL选择B+树作为主要索引数据结构的原因包括：

- **查询效率稳定**：B+树的查询复杂度为O(log n)，且所有查询都需要到达叶子节点，查询时间相对稳定
- **范围查询高效**：B+树的叶子节点通过双向链表连接，便于进行范围查询
- **排序操作高效**：索引本身是有序的，可以避免额外的排序操作
- **磁盘I/O友好**：B+树的节点大小通常与磁盘页大小一致，减少磁盘I/O次数
- **适合大量数据**：B+树的高度较低，即使数据量大，查询效率也很高
- **支持前缀匹配**：对于复合索引，支持最左前缀匹配

### 2. 聚簇索引和非聚簇索引有什么区别？

**答案：**

聚簇索引和非聚簇索引的主要区别在于数据的存储方式：

- **聚簇索引**：
  - 数据行直接存储在索引的叶子节点中
  - 一个表只能有一个聚簇索引
  - InnoDB存储引擎中，主键索引就是聚簇索引
  - 查询效率更高，因为可以直接从索引中获取数据

- **非聚簇索引**：
  - 索引的叶子节点存储指向数据行的指针或主键值
  - 一个表可以有多个非聚簇索引
  - MyISAM存储引擎中，所有索引都是非聚簇索引
  - 查询时可能需要回表操作，效率相对较低

### 3. 什么是最左前缀原则？

**答案：**

最左前缀原则是指在复合索引中，MySQL会从索引的最左侧开始匹配，直到遇到范围查询（如>、<、BETWEEN等）或使用了函数操作。

例如，对于复合索引`(a, b, c)`，MySQL可以使用该索引的场景包括：
- `WHERE a = 1`
- `WHERE a = 1 AND b = 2`
- `WHERE a = 1 AND b = 2 AND c = 3`

但不能使用该索引的场景包括：
- `WHERE b = 2`
- `WHERE c = 3`
- `WHERE b = 2 AND c = 3`

### 4. 什么是覆盖索引？使用覆盖索引有什么好处？

**答案：**

覆盖索引是一种特殊的索引，索引包含了查询所需的所有列，无需回表查询数据行。

使用覆盖索引的好处包括：
- **减少磁盘I/O**：查询只需要扫描索引，无需访问数据行
- **提高查询效率**：避免了回表操作，减少了数据读取量
- **减少内存占用**：只需要加载索引数据，不需要加载整行数据

### 5. 如何选择合适的列作为索引？

**答案：**

选择合适的列作为索引应考虑以下因素：

- **选择性**：选择区分度高的列作为索引，选择性越高，索引的效率越高
- **查询频率**：在经常用于查询条件的列上创建索引
- **排序和分组**：在经常用于排序和分组的列上创建索引
- **数据类型**：选择数据类型较小的列作为索引，减少索引的存储空间
- **最左前缀原则**：考虑复合索引的最左前缀原则，合理安排索引列的顺序
- **避免过度索引**：只在需要的列上创建索引，过多的索引会增加维护成本

### 6. 索引的优缺点是什么？

**答案：**

索引的优点：
- **提高查询速度**：通过索引快速定位数据，避免全表扫描
- **加速排序和分组**：索引通常是有序的，可以加速ORDER BY和GROUP BY操作
- **保证数据完整性**：唯一索引可以确保列或列组合的值唯一
- **减少磁盘I/O**：通过索引减少需要读取的数据量

索引的缺点：
- **存储空间**：索引需要额外的存储空间
- **插入/更新/删除开销**：修改表数据时，需要同时更新索引
- **维护成本**：过多的索引会增加数据库的维护成本
- **可能导致查询优化器选择错误的索引**：当有多个索引时，查询优化器可能选择效率较低的索引

### 7. 什么是索引失效？有哪些情况会导致索引失效？

**答案：**

索引失效是指MySQL在查询时无法使用索引，而选择全表扫描的情况。

导致索引失效的常见情况包括：
- **使用函数或表达式**：在索引列上使用函数或表达式
- **类型转换**：查询条件中的数据类型与索引列的类型不匹配
- **不等于操作**：使用!=或<>操作符
- **IS NULL/IS NOT NULL**：对索引列使用IS NULL或IS NOT NULL操作
- **LIKE查询以%开头**：如`WHERE name LIKE '%张'`
- **范围查询后的条件**：复合索引中，范围查询后的条件无法使用索引
- **OR连接的条件**：OR连接的条件中，如果有一个条件不使用索引，整个查询可能不使用索引
- **索引列使用NOT IN**：使用NOT IN操作符

### 8. 主键索引和唯一索引有什么区别？

**答案：**

主键索引和唯一索引的主要区别包括：

- **唯一性**：主键索引要求列值唯一且非空，唯一索引要求列值唯一但允许一个NULL值
- **数量限制**：一个表只能有一个主键索引，但可以有多个唯一索引
- **存储方式**：InnoDB存储引擎中，主键索引采用聚簇索引的方式存储，唯一索引采用非聚簇索引的方式存储
- **自动创建**：如果没有指定主键，InnoDB会自动选择一个非空的唯一索引作为主键

### 9. 什么是前缀索引？什么时候应该使用前缀索引？

**答案：**

前缀索引是对列值的前缀部分建立的索引，可以减少索引的存储空间。

应该使用前缀索引的情况包括：
- **长字符串列**：如URL、邮箱地址等，这些列的前几个字符就具有较高的选择性
- **存储空间限制**：当索引的存储空间成为问题时，可以考虑使用前缀索引
- **查询需求**：如果查询主要基于列的前缀部分，使用前缀索引可以提高查询效率

使用前缀索引时，需要选择合适的前缀长度，平衡索引的选择性和存储空间。

### 10. 如何优化索引？

**答案：**

优化索引的方法包括：

- **选择合适的索引类型**：根据查询需求选择合适的索引类型
- **遵循最左前缀原则**：合理设计复合索引的列顺序
- **使用覆盖索引**：减少回表操作
- **避免过度索引**：只在需要的列上创建索引
- **定期分析和优化表**：使用`ANALYZE TABLE`和`OPTIMIZE TABLE`命令
- **监控索引使用情况**：使用`SHOW INDEX`和`EXPLAIN`命令分析索引的使用情况
- **避免索引失效**：避免导致索引失效的查询操作
- **考虑数据分布**：根据数据的分布情况调整索引策略