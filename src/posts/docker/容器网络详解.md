---
date: 2026-02-03
author: Gaaming Zhang
isOriginal: false
article: true
category:
  - docker
tag:
  - docker
  - ClaudeCode
---

# 容器网络详解

## 为什么容器需要网络？

每个容器都运行着一个或多个应用程序，这些应用程序通常需要：
- 与其他容器通信（比如Web应用访问数据库）
- 与外部世界通信（比如下载依赖、调用API）
- 被外部用户访问（比如用户访问Web应用）

Docker网络解决的就是"容器如何与其他事物通信"这个问题。

## 理解Docker网络的基础

### 每个容器都有独立的网络空间

还记得Docker用Namespace实现隔离吗？其中**Network Namespace**让每个容器拥有独立的网络栈，包括：
- 独立的网卡接口
- 独立的IP地址
- 独立的路由表
- 独立的端口空间

这就像每个容器都是一台独立的"小电脑"，有自己的网络配置。

### 默认的bridge网络

当你安装Docker后，它会自动创建一个名为`bridge`的网络（对应Linux上的`docker0`网桥）。默认情况下，所有容器都连接到这个网络。

```
      外部网络
          │
    ┌─────┴─────┐
    │  主机网卡  │
    │   eth0    │
    └─────┬─────┘
          │ NAT
    ┌─────┴─────┐
    │  docker0  │ 172.17.0.1
    │  (网桥)    │
    └─────┬─────┘
          │
    ┌─────┼─────┐
    │     │     │
  容器A  容器B  容器C
172.17.0.2  .3  .4
```

可以这样理解：docker0就像家里的路由器，所有容器都连接到这个路由器上，获得同一个网段的IP地址。

## 四种网络模式

Docker提供了几种不同的网络模式，适用于不同场景。

### 1. bridge模式（默认）

这是最常用的模式。每个容器获得独立的IP，通过docker0网桥与其他容器通信。

**特点**：
- 容器之间可以通过IP互相访问
- 容器可以访问外网（通过NAT）
- 外部默认不能直接访问容器（需要端口映射）

**适用场景**：大多数单机部署场景

### 2. host模式

容器不再有独立的网络空间，而是直接使用宿主机的网络。

**特点**：
- 没有网络隔离，容器和主机共用端口
- 性能最好（没有网络虚拟化开销）
- 容器的8080端口就是主机的8080端口

```bash
docker run --network host nginx
# nginx直接监听主机的80端口
```

**适用场景**：对网络性能要求极高的应用

**风险**：失去了网络隔离，端口可能冲突

### 3. none模式

容器没有任何网络配置，只有lo回环接口。

```bash
docker run --network none alpine
# 容器内只能localhost通信
```

**适用场景**：
- 不需要网络的批处理任务
- 需要自己配置复杂网络的场景
- 安全敏感的应用

### 4. overlay模式（多主机）

用于跨主机的容器通信，主要在Docker Swarm或Kubernetes中使用。它在多个Docker主机之间创建一个虚拟网络，让容器仿佛在同一个局域网中。

## 自定义bridge网络

虽然默认bridge网络能用，但它有个重要限制：**容器之间不能通过名称互相访问**，只能用IP。

这在实际使用中很不方便——容器重启后IP可能变化，你不可能每次都去查IP。

**解决方案**：创建自定义bridge网络。

```bash
# 创建自定义网络
docker network create myapp-network

# 在自定义网络中运行容器
docker run -d --name redis --network myapp-network redis:7
docker run -d --name web --network myapp-network myapp

# 现在web容器可以直接用"redis"这个名字访问redis容器
# 比如连接地址可以写：redis:6379
```

**自定义网络的优势**：
- 容器可以通过名称互相发现（内置DNS）
- 更好的隔离性（不同网络的容器默认不能通信）
- 可以自定义IP范围
- 容器可以在运行时加入或离开网络

## 端口映射：让外部访问容器

容器默认是"隐藏"在docker0网桥后面的，外部网络无法直接访问。要让外部用户访问容器内的服务，需要做**端口映射**。

```bash
# 将主机的8080端口映射到容器的80端口
docker run -d -p 8080:80 nginx

# 现在访问 http://主机IP:8080 就能访问到nginx
```

端口映射的格式是 `-p 主机端口:容器端口`。

**几种常见写法**：

| 写法 | 含义 |
|------|------|
| `-p 8080:80` | 主机8080 → 容器80 |
| `-p 80` | 随机主机端口 → 容器80 |
| `-p 127.0.0.1:8080:80` | 只监听本机的8080端口 |
| `-p 8080:80/udp` | UDP端口映射 |

**查看端口映射**：
```bash
docker port <容器名>
```

## Docker Compose中的网络

使用Docker Compose时，网络管理变得更简单。

Compose会自动创建一个网络，所有服务都连接到这个网络，并且**可以用服务名互相访问**。

```yaml
# docker-compose.yml
version: '3.8'
services:
  web:
    image: nginx
    ports:
      - "8080:80"

  api:
    image: my-api
    # 可以用 http://db:5432 访问数据库
    environment:
      - DATABASE_URL=postgres://db:5432/mydb

  db:
    image: postgres:15
```

在这个例子中：
- 三个服务自动在同一个网络中
- web可以通过`api`访问api服务
- api可以通过`db`访问数据库
- 用户通过主机的8080端口访问web

## 常见问题

### Q1: 容器之间ping不通？

**排查步骤**：

1. 确认容器在同一个网络中
   ```bash
   docker inspect <容器名> | grep NetworkMode
   ```

2. 如果使用默认bridge网络，只能用IP访问，不能用名称

3. 检查是否有防火墙规则阻止

**最佳实践**：使用自定义网络，让容器可以通过名称互访。

### Q2: 容器访问不了外网？

**可能原因**：

1. DNS配置问题
   ```bash
   # 进入容器检查DNS
   docker exec -it <容器名> cat /etc/resolv.conf
   ```

2. 主机的IP转发未开启
   ```bash
   # 检查
   sysctl net.ipv4.ip_forward
   # 应该是1
   ```

3. 防火墙/iptables规则问题

### Q3: 端口映射后外部还是访问不了？

**检查清单**：

1. 容器内服务是否正常运行？
   ```bash
   docker logs <容器名>
   ```

2. 服务是否监听了正确的地址？
   - 有些应用默认只监听127.0.0.1，需要改成0.0.0.0

3. 主机防火墙是否放行了端口？

4. 云服务器的安全组是否放行？

### Q4: 如何让容器使用固定IP？

```bash
# 创建网络时指定子网
docker network create --subnet 172.20.0.0/16 mynetwork

# 运行容器时指定IP
docker run --network mynetwork --ip 172.20.0.100 myapp
```

**注意**：在Kubernetes等编排系统中，通常不建议使用固定IP，而是通过Service来实现服务发现。

### Q5: 什么时候用host模式？

host模式牺牲隔离性换取性能，适用于：
- 性能敏感的网络应用
- 需要处理大量端口的应用（如端口扫描工具）
- 需要访问主机网络底层功能的应用

**不建议**在生产环境的普通应用中使用host模式。

## 小结

Docker网络的核心概念：

- **Network Namespace**提供了网络隔离的基础
- **bridge模式**是默认和最常用的模式，通过docker0网桥连接容器
- **自定义bridge网络**支持容器名称发现，推荐使用
- **端口映射**让外部可以访问容器服务
- **Docker Compose**简化了多容器网络管理

**最佳实践**：
- 使用自定义bridge网络而不是默认bridge
- 通过服务名访问容器，而不是IP
- 只映射必要的端口到主机
- 对于多容器应用，使用Docker Compose管理网络

## 参考资源

- [Docker 网络官方文档](https://docs.docker.com/network/)
- [Bridge 网络详解](https://docs.docker.com/network/drivers/bridge/)
- [Overlay 网络配置](https://docs.docker.com/network/drivers/overlay/)
