---
date: 2026-02-03
author: Gaaming Zhang
isOriginal: false
article: true
category:
  - docker
tag:
  - docker
  - ClaudeCode
---

# 镜像安全扫描

## 概述

容器镜像可能包含已知的安全漏洞、恶意软件或配置问题。镜像安全扫描是容器安全的重要环节，通过扫描工具检测镜像中的漏洞、恶意代码和安全配置问题，帮助在部署前发现并修复安全风险。

## 安全威胁类型

```
┌────────────────────────────────────────────────────────────────┐
│                    Image Security Threats                       │
│                                                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ 漏洞         │  │ 恶意软件     │  │ 配置问题     │        │
│  │              │  │              │  │              │        │
│  │ - CVE漏洞    │  │ - 后门程序   │  │ - Root用户   │        │
│  │ - 过期软件   │  │ - 挖矿程序   │  │ - 敏感数据   │        │
│  │ - 不安全依赖 │  │ - 木马       │  │ - 不安全权限 │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## 常用扫描工具

| 工具 | 类型 | 特点 |
|------|------|------|
| **Trivy** | 开源 | 简单易用，支持多种目标 |
| **Docker Scout** | 官方 | Docker集成，SBOM支持 |
| **Grype** | 开源 | Anchore开源，高性能 |
| **Clair** | 开源 | 静态分析，API驱动 |
| **Snyk** | 商业 | 全面的安全平台 |
| **Aqua** | 商业 | 企业级容器安全 |

## Trivy

Trivy是最流行的开源漏洞扫描工具之一。

### 安装

```bash
# macOS
brew install trivy

# Linux (Debian/Ubuntu)
sudo apt-get install wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy

# Docker运行
docker run aquasec/trivy image nginx:latest
```

### 镜像扫描

```bash
# 基本扫描
trivy image nginx:latest

# 只显示高危和严重漏洞
trivy image --severity HIGH,CRITICAL nginx:latest

# 如果发现漏洞则退出码非0（用于CI/CD）
trivy image --exit-code 1 --severity CRITICAL nginx:latest

# 忽略未修复的漏洞
trivy image --ignore-unfixed nginx:latest

# JSON输出
trivy image --format json --output report.json nginx:latest

# 扫描前先拉取
trivy image --pull-policy always nginx:latest
```

### 文件系统扫描

```bash
# 扫描项目目录
trivy fs /path/to/project

# 扫描Dockerfile
trivy config Dockerfile

# 扫描IaC文件
trivy config --file-patterns "*.yaml" .
```

### SBOM生成

```bash
# 生成SBOM（软件物料清单）
trivy image --format cyclonedx --output sbom.json nginx:latest

# SPDX格式
trivy image --format spdx --output sbom.spdx nginx:latest
```

### 配置文件

```yaml
# trivy.yaml
severity:
  - CRITICAL
  - HIGH

exit-code: 1

ignore-unfixed: true

vuln-type:
  - os
  - library

security-checks:
  - vuln
  - config
  - secret

timeout: 10m
```

## Docker Scout

Docker官方的安全扫描工具。

### 基本使用

```bash
# 扫描本地镜像
docker scout cves myimage:latest

# 快速概览
docker scout quickview myimage:latest

# 查看推荐修复
docker scout recommendations myimage:latest

# 比较两个镜像
docker scout compare myimage:v1 myimage:v2
```

### 详细分析

```bash
# 查看所有CVE
docker scout cves --only-vuln-packages myimage:latest

# 过滤严重程度
docker scout cves --only-severity critical,high myimage:latest

# 输出SBOM
docker scout sbom myimage:latest

# JSON格式
docker scout cves --format sarif --output results.sarif myimage:latest
```

### Docker Hub集成

```bash
# 启用自动扫描（Docker Hub）
# 在仓库设置中开启"Vulnerability scanning"

# 通过CI/CD扫描并上传结果
docker scout cves --org myorg myimage:latest
```

## Grype

Anchore开源的漏洞扫描工具。

### 安装使用

```bash
# 安装
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# 基本扫描
grype nginx:latest

# 输出格式
grype -o json nginx:latest > results.json
grype -o table nginx:latest
grype -o cyclonedx nginx:latest

# 严重程度过滤
grype nginx:latest --fail-on critical
```

### 配置

```yaml
# .grype.yaml
check-for-app-update: false
fail-on-severity: high
add-cpes-if-none: false
scope: "AllLayers"
quiet: false

db:
  auto-update: true
  validate-by-hash-on-get: false
```

## Snyk

商业级安全平台，提供容器扫描功能。

### 使用

```bash
# 安装
npm install -g snyk

# 认证
snyk auth

# 扫描镜像
snyk container test nginx:latest

# 监控镜像
snyk container monitor nginx:latest

# 生成HTML报告
snyk container test nginx:latest --json | snyk-to-html -o report.html
```

## CI/CD集成

### GitHub Actions

```yaml
# .github/workflows/security.yml
name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build image
        run: docker build -t myapp:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
```

### GitLab CI

```yaml
# .gitlab-ci.yml
stages:
  - build
  - scan
  - deploy

build:
  stage: build
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

security_scan:
  stage: scan
  image:
    name: aquasec/trivy
    entrypoint: [""]
  script:
    - trivy image --exit-code 1 --severity CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  allow_failure: false

deploy:
  stage: deploy
  script:
    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:latest
  needs:
    - security_scan
```

### Jenkins

```groovy
// Jenkinsfile
pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                sh 'docker build -t myapp:${BUILD_NUMBER} .'
            }
        }

        stage('Security Scan') {
            steps {
                sh '''
                    trivy image \
                        --exit-code 1 \
                        --severity HIGH,CRITICAL \
                        --no-progress \
                        myapp:${BUILD_NUMBER}
                '''
            }
        }

        stage('Push') {
            when {
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
            }
            steps {
                sh '''
                    docker tag myapp:${BUILD_NUMBER} registry.example.com/myapp:${BUILD_NUMBER}
                    docker push registry.example.com/myapp:${BUILD_NUMBER}
                '''
            }
        }
    }

    post {
        failure {
            emailext subject: 'Security Scan Failed',
                     body: 'Vulnerabilities found in image myapp:${BUILD_NUMBER}',
                     recipientProviders: [developers()]
        }
    }
}
```

## Harbor集成扫描

Harbor内置了Trivy扫描功能。

### 配置Harbor扫描

```yaml
# harbor.yml
trivy:
  ignore_unfixed: false
  skip_update: false
  offline_scan: false
  security_check: vuln
  insecure: false
```

### 使用Harbor扫描

```bash
# 推送镜像后自动扫描（在Harbor配置中启用）

# 手动触发扫描
# 通过Harbor UI: Projects -> Repository -> Scan

# 通过API
curl -X POST "https://harbor.example.com/api/v2.0/projects/myproject/repositories/myimage/artifacts/latest/scan" \
  -H "Authorization: Basic $(echo -n 'admin:password' | base64)"

# 查看扫描结果
curl "https://harbor.example.com/api/v2.0/projects/myproject/repositories/myimage/artifacts/latest?with_scan_overview=true" \
  -H "Authorization: Basic $(echo -n 'admin:password' | base64)"
```

### 配置扫描策略

```bash
# 阻止有严重漏洞的镜像拉取
# Harbor UI: Administration -> Configuration -> System Settings
# 启用 "Prevent vulnerable images from running"
# 设置 CVE 白名单
```

## 漏洞修复

### 分析扫描结果

```bash
# 查看详细漏洞信息
trivy image --severity CRITICAL nginx:latest

# 输出示例
nginx:latest (debian 11.6)
============================
Total: 12 (CRITICAL: 2, HIGH: 10)

┌──────────────────┬────────────────┬──────────┬───────────────────┐
│     Library      │ Vulnerability  │ Severity │  Fixed Version    │
├──────────────────┼────────────────┼──────────┼───────────────────┤
│ libssl1.1        │ CVE-2023-0286  │ CRITICAL │ 1.1.1t-1          │
│ openssl          │ CVE-2023-0286  │ CRITICAL │ 1.1.1t-1          │
└──────────────────┴────────────────┴──────────┴───────────────────┘
```

### 修复策略

```dockerfile
# 1. 更新基础镜像
FROM nginx:1.25-alpine  # 使用最新版本

# 2. 更新系统包
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 3. 使用minimal镜像
FROM gcr.io/distroless/static

# 4. 多阶段构建减少攻击面
FROM node:18 AS builder
WORKDIR /app
COPY . .
RUN npm ci && npm run build

FROM node:18-slim
COPY --from=builder /app/dist /app
CMD ["node", "/app/index.js"]
```

### 漏洞豁免

```yaml
# .trivyignore
# 格式：CVE-ID
CVE-2023-0286
CVE-2023-0215

# 或创建策略文件
# trivy-policy.yaml
severity:
  - CRITICAL

vulnerability:
  ignoreUnfixed: true

  ignore:
    - CVE-2023-0286
    - CVE-2023-0215
```

## 最佳实践

### 构建安全镜像

```dockerfile
# 1. 使用官方minimal镜像
FROM python:3.11-slim-bookworm

# 2. 固定版本
FROM python:3.11.4-slim-bookworm@sha256:abc123...

# 3. 非root用户
RUN useradd -r -u 1000 appuser
USER appuser

# 4. 最小权限
RUN chmod 500 /app/myapp

# 5. 清理缓存和临时文件
RUN pip install --no-cache-dir -r requirements.txt && \
    rm -rf /root/.cache /tmp/*

# 6. 使用COPY而不是ADD
COPY requirements.txt .

# 7. 健康检查
HEALTHCHECK CMD curl -f http://localhost/health || exit 1
```

### 扫描策略

```bash
# 1. 构建时扫描
docker build -t myapp . && trivy image --exit-code 1 myapp

# 2. 推送前扫描（CI/CD）
# 只有扫描通过才能推送

# 3. 定期扫描已部署镜像
# 设置定时任务扫描运行中的容器

# 4. 监控新漏洞
# 订阅CVE通知，及时更新镜像
```

## 实用命令

```bash
# Trivy扫描
trivy image --severity HIGH,CRITICAL myimage:latest
trivy image --exit-code 1 myimage:latest
trivy image --format json myimage:latest

# Docker Scout
docker scout cves myimage:latest
docker scout quickview myimage:latest
docker scout recommendations myimage:latest

# Grype
grype myimage:latest
grype --fail-on critical myimage:latest
```

## 常见问题

### Q1: 扫描结果太多漏洞如何处理？

```bash
# 1. 优先处理CRITICAL和HIGH
trivy image --severity CRITICAL,HIGH myimage

# 2. 忽略无法修复的漏洞
trivy image --ignore-unfixed myimage

# 3. 更新基础镜像
FROM debian:bookworm-slim  # 使用最新版本

# 4. 评估风险，创建豁免列表
echo "CVE-2023-XXXX" >> .trivyignore
```

### Q2: 如何自动化扫描流程？

```yaml
# GitHub Actions示例
name: Security Scan
on:
  schedule:
    - cron: '0 0 * * *'  # 每天扫描
  push:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'myregistry/myimage:latest'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
```

### Q3: 扫描会影响CI/CD速度吗？

```bash
# 1. 使用缓存
trivy image --cache-dir /tmp/trivy-cache myimage

# 2. 并行扫描
trivy image --parallel 4 myimage

# 3. 离线数据库
trivy image --skip-db-update myimage

# 4. 只扫描变更的镜像
# 在CI中使用条件判断
```

### Q4: 如何处理私有仓库的镜像扫描？

```bash
# 配置认证
export TRIVY_USERNAME=myuser
export TRIVY_PASSWORD=mypassword

# 或使用Docker配置
docker login registry.example.com
trivy image registry.example.com/myimage:latest

# 使用insecure仓库
trivy image --insecure registry.example.com/myimage:latest
```

### Q5: 扫描报告如何与团队共享？

```bash
# 生成HTML报告
trivy image --format template \
  --template "@contrib/html.tpl" \
  --output report.html \
  myimage:latest

# 上传到S3/OSS
aws s3 cp report.html s3://security-reports/

# 集成到Slack/邮件
# 在CI/CD中添加通知步骤
```

## 参考资源

- [Trivy 官方文档](https://aquasecurity.github.io/trivy/)
- [Docker Scout 文档](https://docs.docker.com/scout/)
- [镜像安全最佳实践](https://docs.docker.com/scout/policy/)
