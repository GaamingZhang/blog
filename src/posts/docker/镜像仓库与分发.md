---
date: 2026-02-03
author: Gaaming Zhang
isOriginal: false
article: true
category:
  - docker
tag:
  - docker
  - ClaudeCode
---

# 镜像仓库与分发

## 概述

Docker镜像仓库（Registry）是存储和分发Docker镜像的服务。了解镜像的推送、拉取以及私有仓库的搭建，是Docker运维的重要技能。本文介绍Docker Hub、私有仓库搭建（Registry/Harbor）以及镜像分发的最佳实践。

## Docker Hub

Docker Hub是Docker官方的公共镜像仓库，提供免费和付费服务。

### 基本操作

```bash
# 登录Docker Hub
docker login
# 输入用户名和密码

# 登录到指定仓库
docker login registry.example.com

# 查看登录状态
cat ~/.docker/config.json

# 登出
docker logout
```

### 镜像命名规范

```
[registry]/[namespace]/[repository]:[tag]

示例：
docker.io/library/nginx:latest        # 官方镜像
docker.io/myuser/myapp:v1.0           # 用户镜像
registry.example.com/team/app:latest  # 私有仓库镜像
```

### 推送镜像

```bash
# 1. 构建镜像
docker build -t myapp:v1.0 .

# 2. 标记镜像（添加仓库地址）
docker tag myapp:v1.0 myuser/myapp:v1.0

# 3. 推送镜像
docker push myuser/myapp:v1.0

# 推送所有标签
docker push myuser/myapp --all-tags
```

### 拉取镜像

```bash
# 拉取最新版本
docker pull nginx

# 拉取指定版本
docker pull nginx:1.25.3

# 拉取指定平台
docker pull --platform linux/arm64 nginx:latest
```

## 搭建私有Registry

### 使用Docker Registry

```bash
# 快速启动（无认证）
docker run -d \
  --name registry \
  -p 5000:5000 \
  -v /data/registry:/var/lib/registry \
  registry:2

# 验证
curl http://localhost:5000/v2/_catalog
```

### 配置TLS证书

```bash
# 生成自签名证书
mkdir -p /data/certs
openssl req -newkey rsa:4096 -nodes -sha256 \
  -keyout /data/certs/domain.key \
  -x509 -days 365 \
  -out /data/certs/domain.crt \
  -subj "/CN=registry.example.com"

# 启动带TLS的Registry
docker run -d \
  --name registry \
  -p 5000:5000 \
  -v /data/registry:/var/lib/registry \
  -v /data/certs:/certs \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  registry:2
```

### 配置基本认证

```bash
# 创建密码文件
mkdir -p /data/auth
docker run --rm \
  --entrypoint htpasswd \
  httpd:2 -Bbn admin password123 > /data/auth/htpasswd

# 启动带认证的Registry
docker run -d \
  --name registry \
  -p 5000:5000 \
  -v /data/registry:/var/lib/registry \
  -v /data/auth:/auth \
  -v /data/certs:/certs \
  -e REGISTRY_AUTH=htpasswd \
  -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  registry:2
```

### Registry配置文件

```yaml
# /etc/docker/registry/config.yml
version: 0.1
log:
  level: info
  formatter: text
storage:
  filesystem:
    rootdirectory: /var/lib/registry
  delete:
    enabled: true
  cache:
    blobdescriptor: inmemory
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
  tls:
    certificate: /certs/domain.crt
    key: /certs/domain.key
auth:
  htpasswd:
    realm: basic-realm
    path: /auth/htpasswd
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
```

## 搭建Harbor

Harbor是VMware开源的企业级Registry，提供更丰富的功能。

### Harbor特性

- Web UI管理界面
- 基于角色的访问控制（RBAC）
- 镜像漏洞扫描
- 镜像签名
- 镜像复制
- 审计日志
- LDAP/AD集成

### 安装Harbor

```bash
# 下载Harbor离线安装包
wget https://github.com/goharbor/harbor/releases/download/v2.9.0/harbor-offline-installer-v2.9.0.tgz
tar xzf harbor-offline-installer-v2.9.0.tgz
cd harbor

# 复制配置文件
cp harbor.yml.tmpl harbor.yml
```

### 配置harbor.yml

```yaml
# harbor.yml
hostname: harbor.example.com

http:
  port: 80

https:
  port: 443
  certificate: /data/cert/harbor.crt
  private_key: /data/cert/harbor.key

harbor_admin_password: Harbor12345

database:
  password: root123
  max_idle_conns: 50
  max_open_conns: 1000

data_volume: /data/harbor

trivy:
  ignore_unfixed: false
  skip_update: false
  insecure: false

jobservice:
  max_job_workers: 10

notification:
  webhook_job_max_retry: 10

log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /var/log/harbor

_version: 2.9.0

proxy:
  http_proxy:
  https_proxy:
  no_proxy:
  components:
    - core
    - jobservice
    - trivy
```

### 安装和启动

```bash
# 安装Harbor
./install.sh --with-trivy

# 启动/停止Harbor
docker-compose up -d
docker-compose down

# 查看状态
docker-compose ps
```

### Harbor使用

```bash
# 登录Harbor
docker login harbor.example.com

# 推送镜像
docker tag myapp:v1.0 harbor.example.com/myproject/myapp:v1.0
docker push harbor.example.com/myproject/myapp:v1.0

# 拉取镜像
docker pull harbor.example.com/myproject/myapp:v1.0
```

## 配置Docker客户端

### 配置镜像加速

```json
// /etc/docker/daemon.json
{
  "registry-mirrors": [
    "https://mirror.ccs.tencentyun.com",
    "https://registry.docker-cn.com"
  ]
}
```

```bash
# 重启Docker
sudo systemctl restart docker
```

### 配置私有仓库

```json
// /etc/docker/daemon.json
{
  "insecure-registries": [
    "192.168.1.100:5000",
    "registry.internal.com"
  ]
}
```

### 配置证书信任

```bash
# 方式1：系统级信任
sudo cp domain.crt /usr/local/share/ca-certificates/registry.crt
sudo update-ca-certificates

# 方式2：Docker级信任
sudo mkdir -p /etc/docker/certs.d/registry.example.com:5000
sudo cp domain.crt /etc/docker/certs.d/registry.example.com:5000/ca.crt

# 重启Docker
sudo systemctl restart docker
```

## 镜像管理

### 查看镜像仓库内容

```bash
# 列出所有镜像
curl -s http://localhost:5000/v2/_catalog | jq

# 列出镜像的所有标签
curl -s http://localhost:5000/v2/myapp/tags/list | jq

# 获取镜像manifest
curl -s -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
  http://localhost:5000/v2/myapp/manifests/latest | jq
```

### 删除镜像

```bash
# 获取镜像digest
DIGEST=$(curl -s -I -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
  http://localhost:5000/v2/myapp/manifests/latest | grep Docker-Content-Digest | awk '{print $2}' | tr -d '\r')

# 删除镜像
curl -X DELETE http://localhost:5000/v2/myapp/manifests/$DIGEST

# 执行垃圾回收（释放磁盘空间）
docker exec registry bin/registry garbage-collect /etc/docker/registry/config.yml
```

### 镜像复制

```bash
# 使用skopeo复制镜像
skopeo copy \
  docker://docker.io/library/nginx:latest \
  docker://registry.example.com/library/nginx:latest

# 同步整个仓库
skopeo sync \
  --src docker --dest docker \
  docker.io/library/nginx \
  registry.example.com/library
```

## 镜像分发策略

### 多级仓库架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Hub                              │
│                   (公共镜像源)                               │
└───────────────────────┬─────────────────────────────────────┘
                        │ 同步
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  公司级Registry                              │
│               (Harbor - 总部)                                │
│     - 镜像扫描                                               │
│     - 镜像签名                                               │
│     - 访问控制                                               │
└───────────────────────┬─────────────────────────────────────┘
                        │ 复制
          ┌─────────────┼─────────────┐
          ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 数据中心A   │ │ 数据中心B   │ │ 数据中心C   │
│ Registry    │ │ Registry    │ │ Registry    │
└─────────────┘ └─────────────┘ └─────────────┘
```

### Harbor镜像复制配置

```yaml
# 在Harbor UI中配置复制规则
# 或使用API
POST /api/v2.0/replication/policies
{
  "name": "sync-to-dr",
  "src_registry": {
    "id": 1
  },
  "dest_registry": {
    "id": 2
  },
  "trigger": {
    "type": "event_based"
  },
  "filters": [
    {
      "type": "name",
      "value": "production/**"
    }
  ],
  "enabled": true
}
```

## 实用命令

```bash
# 镜像操作
docker pull <image>
docker push <image>
docker tag <source> <target>
docker images
docker rmi <image>

# Registry管理
docker login <registry>
docker logout <registry>

# 查看镜像详情
docker inspect <image>
docker manifest inspect <image>

# 保存和加载镜像
docker save -o image.tar <image>
docker load -i image.tar

# 导出和导入容器
docker export -o container.tar <container>
docker import container.tar <image>
```

## 常见问题

### Q1: 推送镜像提示"denied: requested access to the resource is denied"？

```bash
# 检查是否登录
docker login

# 检查镜像名称是否包含正确的namespace
docker tag myapp myuser/myapp  # Docker Hub需要包含用户名
docker tag myapp harbor.example.com/project/myapp  # 私有仓库需要完整路径
```

### Q2: 拉取私有仓库镜像提示证书错误？

```bash
# 方案1：添加到insecure-registries
# /etc/docker/daemon.json
{
  "insecure-registries": ["registry.example.com"]
}

# 方案2：添加CA证书
mkdir -p /etc/docker/certs.d/registry.example.com
cp ca.crt /etc/docker/certs.d/registry.example.com/

# 重启Docker
systemctl restart docker
```

### Q3: 如何清理Registry磁盘空间？

```bash
# 1. 删除不需要的镜像标签
# 2. 执行垃圾回收
docker exec registry bin/registry garbage-collect /etc/docker/registry/config.yml

# 3. 删除数据后需要重启Registry
docker restart registry
```

### Q4: 如何限制Registry磁盘使用？

```yaml
# config.yml
storage:
  filesystem:
    rootdirectory: /var/lib/registry
    maxthreads: 100
  maintenance:
    uploadpurging:
      enabled: true
      age: 168h  # 7天
      interval: 24h
      dryrun: false
```

### Q5: 如何实现镜像自动同步？

1. **Harbor复制**：使用Harbor的复制功能
2. **skopeo + cron**：定时同步脚本
3. **registry-sync**：专用同步工具

```bash
# skopeo同步脚本示例
#!/bin/bash
skopeo sync \
  --src docker \
  --dest docker \
  --src-creds user:pass \
  --dest-creds user:pass \
  source.registry.com/library \
  dest.registry.com/library
```
