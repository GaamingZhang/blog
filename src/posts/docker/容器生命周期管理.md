# 容器生命周期管理

## 什么是容器生命周期？

容器就像一个员工，有入职、工作、休假、离职等不同阶段。理解这些状态及其转换，能帮你更好地管理容器、排查问题。

## 容器的状态

容器在其"一生"中会经历以下状态：

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Created │────>│ Running │<───>│ Paused  │
│ (已创建) │     │ (运行中) │     │ (已暂停) │
└─────────┘     └────┬────┘     └─────────┘
                     │
                     ▼
                ┌─────────┐     ┌─────────┐
                │ Stopped │────>│ Removed │
                │ (已停止) │     │ (已删除) │
                └─────────┘     └─────────┘
```

| 状态 | 含义 | 类比 |
|------|------|------|
| **Created** | 容器已创建但未启动 | 员工办完入职手续，还没开始工作 |
| **Running** | 容器正在运行 | 员工正在工作 |
| **Paused** | 容器被暂停，进程被冻结 | 员工休假中，位置保留 |
| **Stopped** | 容器已停止，进程已退出 | 员工下班了 |
| **Removed** | 容器已删除 | 员工离职，工位清空 |

## 创建与启动的区别

很多人分不清`docker create`和`docker run`：

- `docker create`：只创建容器，不启动。就像把材料准备好，但不开工
- `docker run`：创建并启动容器。这是最常用的命令

### 为什么需要单独的create？

有些场景需要先创建再启动：
- 需要先检查容器配置
- 需要先挂载额外的卷
- 编排工具需要精确控制启动时机

## 停止容器的两种方式

### 优雅停止（docker stop）

`docker stop`会先发送**SIGTERM**信号，告诉容器里的进程："请收拾一下，准备关闭"。进程有机会保存数据、关闭连接。

如果进程在10秒内（默认）没有退出，Docker会发送**SIGKILL**信号强制终止。

这就像下班前给员工10分钟时间整理工位，时间到了必须走人。

### 强制终止（docker kill）

`docker kill`直接发送**SIGKILL**信号，立即终止进程，不给任何准备时间。

这就像突然断电，正在进行的工作可能会丢失。

**什么时候用kill？**
- 容器无响应，stop不起作用
- 需要立即终止问题容器
- 测试环境不在乎数据

## 暂停与停止的区别

| 操作 | 进程状态 | 资源占用 | 恢复速度 |
|------|----------|----------|----------|
| **暂停（pause）** | 冻结 | 保留 | 瞬间恢复 |
| **停止（stop）** | 退出 | 部分释放 | 需要重新启动 |

暂停使用Linux的cgroups freezer功能，将进程完全冻结。内存中的数据保持不变，CPU不再调度这个进程。

**暂停的使用场景**：
- 临时释放CPU给其他容器
- 创建一致性的快照
- 调试时冻结状态

## 容器重启策略

容器挂了怎么办？你不可能24小时盯着。Docker提供了自动重启策略：

| 策略 | 含义 |
|------|------|
| `no` | 不自动重启（默认） |
| `always` | 总是重启，包括Docker服务重启后 |
| `unless-stopped` | 除非手动停止，否则总是重启 |
| `on-failure:N` | 只在失败时重启，最多N次 |

**如何选择？**

- `always`：生产环境的关键服务
- `unless-stopped`：大多数生产服务（比always更灵活）
- `on-failure:3`：可能有bug的服务，避免无限重启

**重要区别**：`always`和`unless-stopped`的区别在于Docker服务重启后——always会自动启动容器，unless-stopped只有在之前是运行状态才会启动。

## 理解容器的退出码

容器停止时会有一个退出码（Exit Code），告诉你它是怎么"死"的：

| 退出码 | 含义 |
|--------|------|
| 0 | 正常退出 |
| 1 | 应用错误 |
| 137 | 被SIGKILL杀死（通常是OOM或docker kill） |
| 143 | 被SIGTERM终止（通常是docker stop） |

**137的特殊含义**：如果你发现容器经常以137退出，很可能是内存不够被OOM Killer杀掉了。检查方法：

```bash
docker inspect <container-id> --format='{{.State.OOMKilled}}'
# 如果返回true，确实是内存不足
```

## 容器与主进程的关系

这是一个关键概念：**容器的生命周期与它的主进程（PID 1）绑定**。

主进程退出 = 容器停止

这就是为什么很多初学者会遇到"容器一启动就退出"的问题——他们的主进程执行完就退出了。

**常见错误**：
```bash
# 错误：echo执行完容器就退出了
docker run ubuntu echo "hello"

# 正确：让进程持续运行
docker run -d nginx  # nginx会持续运行
```

## 与容器交互的两种方式

### attach：连接到主进程

`docker attach`连接到容器的主进程（PID 1）。你看到的是主进程的输出，输入也直接发给主进程。

**注意**：按Ctrl+C会发送信号给主进程，可能导致容器停止！安全分离的方式是`Ctrl+P, Ctrl+Q`。

### exec：启动新进程

`docker exec`在容器内启动一个新的进程。最常用的是进入容器的shell：

```bash
docker exec -it mycontainer /bin/bash
```

这不会影响主进程。即使你在shell里执行`exit`，容器也不会停止。

**什么时候用哪个？**
- 想看主进程输出 → attach
- 想进容器调试、执行命令 → exec（大多数情况）

## 容器删除的注意事项

### 删除前的检查

删除容器前，数据会丢失吗？取决于数据存在哪里：

- **容器内部**：删除后数据丢失
- **挂载的卷（Volume）**：数据保留，除非用`-v`参数删除
- **绑定挂载的主机目录**：数据保留在主机上

### 运行中的容器能删除吗？

不能直接删除，需要先停止，或者使用`-f`（force）强制删除。

强制删除相当于先kill再rm，所以会造成数据丢失风险。

## 健康检查机制

Docker可以定期检查容器是否"健康"：

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD curl -f http://localhost/health || exit 1
```

- **interval**：多久检查一次
- **timeout**：检查超时时间
- **retries**：连续失败几次算不健康
- **start-period**：启动后的宽限期

健康检查的结果会显示在`docker ps`的状态列：`healthy`、`unhealthy`、`starting`。

**注意**：Docker本身不会对不健康的容器采取任何动作，它只是报告状态。自动重启需要配合编排工具（如Kubernetes）。

## 常见问题

### Q1: 容器一直重启怎么办？

可能原因：
1. 应用启动失败，配合`--restart=always`导致无限重启
2. 内存不够被OOM反复杀死

排查方法：
1. 用`docker logs <container-id>`查看日志
2. 检查退出码和OOMKilled状态
3. 临时改成`--restart=no`，手动启动调试

### Q2: docker stop很慢怎么办？

默认等待10秒才会强制杀死。如果你的应用不需要那么长时间清理：

```bash
docker stop -t 3 mycontainer  # 只等3秒
```

如果应用确实需要更长时间（比如关闭数据库连接），可以增加等待时间。

### Q3: 容器停止了日志还在吗？

在，容器停止后日志仍然保留，直到容器被删除。这对排查问题很有用。

### Q4: 怎么让容器开机自启动？

两步：
1. 容器使用`--restart=unless-stopped`或`--restart=always`
2. 确保Docker服务开机自启动（大多数安装方式默认启用）

### Q5: 如何清理所有停止的容器？

```bash
docker container prune
```

这会删除所有已停止的容器。如果想保留某些容器，在删除前先用`docker ps -a`确认。

## 小结

| 操作 | 命令 | 效果 |
|------|------|------|
| 创建 | docker create | 准备容器但不运行 |
| 创建并运行 | docker run | 最常用的方式 |
| 启动 | docker start | 启动已停止的容器 |
| 停止 | docker stop | 优雅停止（SIGTERM → SIGKILL） |
| 强制停止 | docker kill | 立即停止（SIGKILL） |
| 暂停 | docker pause | 冻结进程，资源保留 |
| 恢复 | docker unpause | 从暂停中恢复 |
| 删除 | docker rm | 删除容器 |
| 进入容器 | docker exec -it | 在容器中执行命令 |

记住关键点：
- **容器生命周期 = 主进程生命周期**
- **stop是优雅的，kill是暴力的**
- **重启策略能自动处理容器故障**
- **健康检查只报告状态，不采取行动**
