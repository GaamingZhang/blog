---
date: 2025-07-01
author: Gaaming Zhang
isOriginal: false
article: true
category:
  - 操作系统
tag:
  - 操作系统
---

# top：实时系统监控的第一工具

## top 是什么

**top** 是 Linux 系统中最基础、最常用的实时监控工具。它就像汽车的仪表盘，实时显示系统的运行状态：CPU、内存、进程等关键指标。

### 为什么需要 top

**快速诊断**：
- 系统卡顿时，第一时间查看资源占用
- 找出消耗 CPU 或内存最多的进程
- 判断是 CPU、内存还是 I/O 瓶颈

**持续监控**：
- 观察系统负载的变化趋势
- 监控特定进程的资源使用
- 发现异常进程（CPU 飙升、内存泄漏）

**学习工具**：
- 理解 Linux 系统的资源管理
- 观察进程的生命周期和状态
- 学习性能分析的基础

---

## top 显示的信息

top 的界面分为两部分：

```
┌─────────────────────────────────┐
│  系统概要（前 5 行）             │
│  - 系统时间和负载                │
│  - 进程统计                      │
│  - CPU 使用率                    │
│  - 内存使用情况                  │
│  - Swap 使用情况                 │
├─────────────────────────────────┤
│  进程列表                        │
│  - 每个进程的资源占用            │
│  - 按 CPU 或内存排序             │
└─────────────────────────────────┘
```

---

## 理解系统负载（Load Average）

### 什么是负载

**负载**表示系统中等待运行的进程数量（包括正在运行和等待 CPU 的进程）。

top 显示三个时间段的平均负载：
- **1 分钟平均**：短期负载，反映当前状态
- **5 分钟平均**：中期负载，反映最近趋势
- **15 分钟平均**：长期负载，反映整体情况

### 如何判断负载是否正常

**关键公式**：负载 / CPU 核心数

假设系统有 4 个 CPU 核心：
- **负载 1.0**：1.0 / 4 = 0.25（轻负载，25% 利用率）
- **负载 4.0**：4.0 / 4 = 1.0（满负载，100% 利用率）
- **负载 8.0**：8.0 / 4 = 2.0（过载，有进程在排队）

**判断标准**：
- 比值 < 0.7：系统空闲
- 比值 0.7-1.0：负载适中
- 比值 1.0-2.0：负载较高，需要关注
- 比值 > 2.0：过载，可能有性能问题

### 负载的含义

**高负载不一定是坏事**：
- 批处理任务：高负载是正常的
- 多核 CPU：负载 10 在 16 核 CPU 上很正常

**负载趋势更重要**：
- 负载上升：系统压力增加
- 负载稳定：系统运行正常
- 负载下降：压力减轻

---

## 理解 CPU 使用率

CPU 时间被分配到不同的类型：

### 关键指标

**us（user）**：用户态 CPU 时间
- **含义**：应用程序的计算时间
- **高 us 意味着**：应用 CPU 密集（计算、循环）
- **正常值**：30-70%
- **异常值**：>90%（可能是死循环或计算密集）

**sy（system）**：系统态 CPU 时间
- **含义**：内核执行系统调用的时间
- **高 sy 意味着**：频繁系统调用、锁竞争
- **正常值**：5-20%
- **异常值**：>30%（可能是过多系统调用）

**wa（iowait）**：等待 I/O 的时间
- **含义**：CPU 在等待磁盘或网络 I/O
- **高 wa 意味着**：I/O 瓶颈，磁盘太慢
- **正常值**：0-5%
- **异常值**：>20%（磁盘或网络是瓶颈）

**id（idle）**：CPU 空闲时间
- **含义**：CPU 无事可做
- **低 id 意味着**：CPU 资源紧张
- **正常值**：20-70%
- **异常值**：<10%（CPU 不足）

### 诊断思路

```
CPU 使用率分析：
├─ us 高 + wa 低 → CPU 计算密集
│   └─ 优化算法、增加缓存、扩容
├─ sy 高 → 系统调用频繁
│   └─ 减少系统调用、检查锁竞争
├─ wa 高 → I/O 瓶颈
│   └─ 优化磁盘 I/O、使用 SSD
└─ id 低 + us/sy 都不高 → 等待其他资源
    └─ 检查网络、数据库连接
```

---

## 理解内存使用

### 关键概念

**total**：总物理内存
**used**：已使用内存
**free**：完全空闲的内存
**buff/cache**：缓存（可回收）
**available**：实际可用内存（最重要）

### Linux 内存管理的特点

**Linux 会尽量使用内存作为缓存**：
- free 很小是正常的
- buff/cache 大是好事（提高性能）
- available 才是真正可用的内存

**关键公式**：
```
available ≈ free + 大部分 buff/cache
```

### 内存压力判断

**available 的比例**：
- **>20%**：内存充足
- **10-20%**：需要关注
- **<10%**：内存紧张
- **<5%**：严重不足，可能 OOM

**Swap 的使用**：
- **Swap = 0**：完全使用物理内存（理想）
- **Swap < 10%**：偶尔使用，可接受
- **Swap > 50%**：频繁换页，性能下降严重

---

## 理解进程状态

### 进程状态

**R（Running）**：运行中
- 正在使用 CPU 或等待 CPU
- 通常只有少数进程处于此状态

**S（Sleeping）**：睡眠
- 等待事件（I/O、锁、信号）
- 大多数进程处于此状态

**D（Disk Sleep）**：不可中断睡眠
- 等待磁盘 I/O 完成
- 无法被信号中断
- 大量 D 状态进程表示 I/O 瓶颈

**Z（Zombie）**：僵尸进程
- 进程已终止，但父进程未回收
- 少量僵尸进程无害
- 大量僵尸进程表明程序 bug

**T（Stopped）**：停止
- 被信号暂停（Ctrl+Z 或 kill -STOP）

### 进程内存指标

**VIRT（虚拟内存）**：
- 进程申请的全部虚拟内存
- 包括未实际使用的部分
- 数值很大是正常的

**RES（常驻内存）**：
- 实际占用的物理内存
- 最重要的内存指标
- 反映进程真实内存占用

**SHR（共享内存）**：
- 与其他进程共享的内存（如动态库）
- RES - SHR = 进程独占内存

**关键点**：
- VIRT 大不代表内存占用大
- 看 RES 才能知道真实占用
- 多个进程的 RES 相加会重复计算 SHR

---

## 使用 top 的场景

### 场景 1：系统突然变慢

**步骤**：
1. 运行 `top`
2. 查看 Load Average 是否过高
3. 查看 CPU 的 `wa%` 是否高（I/O 瓶颈）
4. 查看 `%CPU` 列，找出占用高的进程
5. 按 `M` 键按内存排序，查看内存占用

**常见原因**：
- 某个进程 CPU 飙升（死循环、计算密集）
- I/O 瓶颈（wa% 高）
- 内存不足（大量使用 Swap）

### 场景 2：查找内存泄漏

**步骤**：
1. 运行 `top`
2. 按 `M` 键按内存排序
3. 观察 RES 列持续增长的进程
4. 记录进程 PID，进一步分析

**特征**：
- RES 持续增长，不回落
- 系统 available 内存持续下降
- 最终可能导致 OOM

### 场景 3：监控特定进程

**步骤**：
1. 找到进程 PID
2. 运行 `top -p PID`
3. 持续观察资源变化

**用途**：
- 监控新部署的服务
- 观察进程在负载下的表现
- 验证优化效果

---

## 常用交互命令

在 top 运行时，可以按键进行交互：

**排序**：
- **P**：按 CPU 使用率排序（默认）
- **M**：按内存使用率排序
- **T**：按运行时间排序

**显示控制**：
- **1**：显示每个 CPU 核心的使用率
- **t**：切换 CPU 显示模式
- **m**：切换内存显示模式

**进程操作**：
- **k**：杀死进程（输入 PID）
- **r**：调整进程优先级

**刷新**：
- **d** 或 **s**：修改刷新间隔（默认 3 秒）
- **q**：退出 top

---

## top vs htop

**htop** 是 top 的增强版，更加友好：

| 特性     | top           | htop                  |
| -------- | ------------- | --------------------- |
| 界面     | 单色文本      | 彩色、更直观          |
| 交互     | 键盘快捷键    | 支持鼠标              |
| CPU 显示 | 需要按 1 展开 | 默认显示所有核心      |
| 进程树   | 不支持        | 支持树状显示          |
| 搜索     | 不支持        | 支持进程名搜索        |
| 安装     | 系统自带      | 需要额外安装          |

**选择建议**：
- 服务器环境：用 top（通用性强）
- 本地开发：用 htop（更友好）
- 学习 Linux：两者都要熟悉

---

## 核心要点

**top 的本质**：实时查看系统资源使用情况的仪表盘。

**关键指标**：
- **Load Average**：系统负载，与 CPU 核心数对比
- **CPU 使用率**：us（应用）、sy（内核）、wa（I/O 等待）、id（空闲）
- **内存使用**：关注 available，而非 free
- **Swap 使用**：超过 50% 表示内存严重不足

**诊断思路**：
1. 先看 Load Average 判断整体压力
2. 看 CPU 各项指标判断瓶颈类型
3. 看内存 available 判断内存压力
4. 找出占用高的进程进行优化

**进程指标**：
- **RES**：实际物理内存占用（最重要）
- **%CPU**：CPU 使用率（多核可超过 100%）
- **状态**：R（运行）、S（睡眠）、D（I/O 等待）、Z（僵尸）

**使用技巧**：
- 按 `P` 按 CPU 排序，找出 CPU 杀手
- 按 `M` 按内存排序，找出内存大户
- 按 `1` 查看每个 CPU 核心，识别负载不均
- `wa%` 高表示 I/O 瓶颈，需要优化磁盘

**最佳实践**：
- 性能问题第一步就是运行 top
- 持续观察，而不是看一次就退出
- 结合其他工具（iostat、vmstat）深入分析
