---
date: 2025-12-28
author: Gaaming Zhang
icon: hugeicons:zip-01
cover: /assets/images/cover1.png
sticky: true
star: true
isOriginal: true
---

# 快速回顾

## TCP 协议

### 头部结构
16位源端口、16位目标端口、32位序列号、32位确认号、4位首部长度、6个保留位、6个标志位（URG紧急指针、ACK确认、PSH推送、RST重置、SYN同步、FIN结束）、16位窗口大小、16位校验和、16位紧急指针、最大40字节的选项字段

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          源端口 (16位)        |        目标端口 (16位)           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        序列号 (32位)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        确认号 (32位)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  首部  |  保留      |U|A|P|R|S|F|           窗口大小 (16位)      |
|  长度  | (6位)      |R|C|S|S|Y|I|                              |
| （4位）|            |G|K|H|T|N|N|                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          校验和 (16位)        |        紧急指针 (16位)           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       选项 (可变长度)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          数据                                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```
### 首部长度
首部长度4位，单位为4字节，默认20字节，最大60字节，其中选项字段长度为0-40字节

### 可靠交付
确认机制、超时重传、快速重传、流量控制、拥塞控制

### 滑动窗口
接收窗口、拥塞窗口、发送窗口=min(接收窗口, 拥塞窗口)

### 拥塞控制
- **慢开始**：初始时，拥塞窗口设为1个MSS（最大报文段大小），每收到一个确认，拥塞窗口加倍，指数增加。
- **拥塞避免**：当拥塞窗口超过拥塞避免阈值（ssthresh）时，进入拥塞避免阶段。每个RTT内，拥塞窗口增加1个MSS，线性增加。
- **快重传**：收到重复确认时，立即重传缺失的数据包，而不是等待超时。
- **快恢复**：在快重传后，进入快恢复阶段。当收到3个重复确认时，拥塞避免阈值设置为当前拥塞窗口的一半，拥塞窗口减半。然后进入拥塞避免阶段。

### 超时重传
如果在超时时间内未收到确认，重传数据包。拥塞窗口重新设置为1个MSS（最大报文段大小）

### 三次握手
1. **第一次握手（SYN）**：
    - 客户端发送 SYN 报文，设置 SYN=1，初始序列号 seq=x
    - 客户端进入 SYN_SENT 状态

2. **第二次握手（SYN/ACK）**：
    - 服务端收到 SYN 报文，回复 SYN/ACK 报文
    - 设置 SYN=1，ACK=1，确认号 ack=x+1，初始序列号 seq=y
    - 服务端进入 SYN_RCVD 状态

3. **第三次握手（ACK）**：
    - 客户端收到 SYN/ACK 报文，回复 ACK 报文
    - 设置 ACK=1，确认号 ack=y+1，序列号 seq=x+1
    - 客户端进入 ESTABLISHED 状态
    - 服务端收到 ACK 报文后，也进入 ESTABLISHED 状态

**三次握手的必要性**：
- 防止历史连接的 SYN 报文干扰新连接
- 确保双方都能正常收发数据
- 初始化双方的序列号，为可靠传输奠定基础

### 四次挥手
1. **第一次挥手（FIN）**：
   - 主动关闭方发送 FIN 报文，设置 FIN=1，序列号 seq=x
   - 主动关闭方进入 FIN_WAIT_1 状态

2. **第二次挥手（ACK）**：
   - 被动关闭方收到 FIN 报文，回复 ACK 报文
   - 设置 ACK=1，确认号 ack=x+1，序列号 seq=y
   - 被动关闭方进入 CLOSE_WAIT 状态
   - 主动关闭方收到 ACK 后，进入 FIN_WAIT_2 状态

3. **第三次挥手（FIN）**：
   - 被动关闭方完成数据发送后，发送 FIN 报文
   - 设置 FIN=1，ACK=1，确认号 ack=x+1，序列号 seq=w
   - 被动关闭方进入 LAST_ACK 状态

4. **第四次挥手（ACK）**：
   - 主动关闭方收到 FIN 报文，回复 ACK 报文
   - 设置 ACK=1，确认号 ack=w+1，序列号 seq=x+1
   - 主动关闭方进入 TIME_WAIT 状态，等待 2MSL 后关闭
   - 被动关闭方收到 ACK 后，进入 CLOSED 状态

**CLOSE_WAIT 状态**
- **被动关闭方**：收到第一次挥手 FIN 报文后，进入 CLOSE_WAIT 状态
- **作用**：
  - 通知应用层连接已关闭，等待应用层处理剩余数据
  - 应用层处理完成后，发送 FIN 报文确认关闭

**TIME_WAIT 状态**
- **主动关闭方**：发送最后一个 ACK 报文，进入 TIME_WAIT 状态
- **持续时间**：2MSL（Maximum Segment Lifetime，报文最大生存时间，通常为 60 秒）
- **作用**：
  - 确保最后一个 ACK 能被对方收到，避免对方超时重发 FIN
  - 确保网络中所有与该连接相关的报文都已消失，防止旧连接报文干扰新连接
- **影响**：大量 TIME_WAIT 连接会占用端口资源，可通过调整内核参数优化