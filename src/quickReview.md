---
date: 2025-12-28
author: Gaaming Zhang
icon: hugeicons:zip-01
cover: /assets/images/cover1.png
sticky: true
star: true
isOriginal: true
---

# 快速回顾

## TCP 协议

提供**面向连接、可靠、有序、字节流**的服务

### 头部结构

16位源端口、16位目标端口、32位序列号、32位确认号、4位首部长度、6个保留位、6个标志位（URG紧急指针、ACK确认、PSH推送、RST重置、SYN同步、FIN结束）、16位窗口大小、16位校验和、16位紧急指针、最大40字节的选项字段
TCP面向字节流，无边界，**无TCP包总长度字段**。
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          源端口 (16位)        |        目标端口 (16位)           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        序列号 (32位)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        确认号 (32位)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  首部  |  保留      |U|A|P|R|S|F|           窗口大小 (16位)      |
|  长度  | (6位)      |R|C|S|S|Y|I|                              |
| （4位）|            |G|K|H|T|N|N|                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          校验和 (16位)        |        紧急指针 (16位)           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       选项 (可变长度)                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          数据                                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 首部长度
首部长度4位，单位为4字节，默认20字节，最大60字节，其中选项字段长度为0-40字节。

### 可靠交付
确认机制、超时重传、快速重传、流量控制、拥塞控制

### 滑动窗口
接收窗口、拥塞窗口、发送窗口=min(接收窗口, 拥塞窗口)

### 拥塞控制
- **慢开始**：初始时，拥塞窗口设为1个MSS（最大报文段大小），每收到一个确认，拥塞窗口加倍，指数增加。
- **拥塞避免**：当拥塞窗口超过拥塞避免阈值（ssthresh）时，进入拥塞避免阶段。每个RTT内，拥塞窗口增加1个MSS，线性增加。
- **快重传**：收到重复确认时，立即重传缺失的数据包，而不是等待超时。
- **快恢复**：在快重传后，进入快恢复阶段。当收到3个重复确认时，拥塞避免阈值设置为当前拥塞窗口的一半，拥塞窗口减半。然后进入拥塞避免阶段。

### 超时重传
如果在超时时间内未收到确认，重传数据包。拥塞窗口重新设置为1个MSS（最大报文段大小）

### 三次握手
1. **第一次握手（SYN）**：
    - 客户端发送 SYN 报文，设置 SYN=1，初始序列号 seq=x
    - 客户端进入 SYN_SENT 状态

2. **第二次握手（SYN/ACK）**：
    - 服务端收到 SYN 报文，回复 SYN/ACK 报文
    - 设置 SYN=1，ACK=1，确认号 ack=x+1，初始序列号 seq=y
    - 服务端进入 SYN_RCVD 状态

3. **第三次握手（ACK）**：
    - 客户端收到 SYN/ACK 报文，回复 ACK 报文
    - 设置 ACK=1，确认号 ack=y+1，序列号 seq=x+1
    - 客户端进入 ESTABLISHED 状态
    - 服务端收到 ACK 报文后，也进入 ESTABLISHED 状态

**三次握手的必要性**：
- 防止历史连接的 SYN 报文干扰新连接
- 确保双方都能正常收发数据
- 初始化双方的序列号，为可靠传输奠定基础

### 四次挥手
1. **第一次挥手（FIN）**：
   - 主动关闭方发送 FIN 报文，设置 FIN=1，序列号 seq=x
   - 主动关闭方进入 FIN_WAIT_1 状态

2. **第二次挥手（ACK）**：
   - 被动关闭方收到 FIN 报文，回复 ACK 报文
   - 设置 ACK=1，确认号 ack=x+1，序列号 seq=y
   - 被动关闭方进入 CLOSE_WAIT 状态
   - 主动关闭方收到 ACK 后，进入 FIN_WAIT_2 状态

3. **第三次挥手（FIN）**：
   - 被动关闭方完成数据发送后，发送 FIN 报文
   - 设置 FIN=1，ACK=1，确认号 ack=x+1，序列号 seq=w
   - 被动关闭方进入 LAST_ACK 状态

4. **第四次挥手（ACK）**：
   - 主动关闭方收到 FIN 报文，回复 ACK 报文
   - 设置 ACK=1，确认号 ack=w+1，序列号 seq=x+1
   - 主动关闭方进入 TIME_WAIT 状态，等待 2MSL 后关闭
   - 被动关闭方收到 ACK 后，进入 CLOSED 状态

**CLOSE_WAIT 状态**
- **被动关闭方**：收到第一次挥手 FIN 报文后，进入 CLOSE_WAIT 状态
- **作用**：
  - 通知应用层连接已关闭，等待应用层处理剩余数据
  - 应用层处理完成后，发送 FIN 报文确认关闭

**TIME_WAIT 状态**
- **主动关闭方**：发送最后一个 ACK 报文，进入 TIME_WAIT 状态
- **持续时间**：2MSL（Maximum Segment Lifetime，报文最大生存时间，通常为 60 秒）
- **作用**：
  - 确保最后一个 ACK 能被对方收到，避免对方超时重发 FIN
  - 确保网络中所有与该连接相关的报文都已消失，防止旧连接报文干扰新连接
- **影响**：大量 TIME_WAIT 连接会占用端口资源，可通过调整内核参数优化

## UDP 协议

提供**最小化传输层服务**，只负责数据报的封装和传输，不保证可靠性和顺序。

### 头部结构

16位源端口、16位目的端口、16位UDP包总长度、16位校验和

```
0      7 8     15 16    23 24    31
+--------+--------+--------+--------+
|   Source Port   |   Dest Port     |
+--------+--------+--------+--------+
|     Length      |    Checksum     |
+--------+--------+--------+--------+
|         Data Payload...           |
+-----------------------------------+
```

### 关键特性
- **无连接**：无需三次握手建立连接，直接发送数据报
- **不可靠传输**：无重传机制、无顺序保证、无拥塞控制
- **低开销**：头部仅 8 字节（远小于TCP的20-60字节）
- **支持多播/广播**：一对多通信场景，如IPTV、局域网设备发现
- **实时性优异**：无TCP的重传延迟和队头阻塞问题
- **数据报完整性**：通过校验和机制检测数据损坏（IPv4可选，IPv6必须）

## QUIC 协议

基于 UDP 的新一代传输层协议

### 头部结构

QUIC协议有两种头部格式：**长头部**（Long Header）和**短头部**（Short Header）。

#### 长头部（Long Header）
用于连接建立、版本协商、0-RTT数据传输等场景。

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1|1|1|T|T|     Type (4位)      |    Version (32位)            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Connection ID                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Source Connection ID                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      Payload Length (16位)                   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Packet Number (PN)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Payload...                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**字段说明**：
- **Header Form (1位)**：1表示长头部
- **Fixed Bit (1位)**：固定为1
- **Long Packet Type (2位)**：标识长头部类型
  - 0x00：Initial（初始包）
  - 0x01：0-RTT Protected（0-RTT保护包）
  - 0x02：Handshake（握手包）
  - 0x03：Retry（重试包）
- **Type-Specific Bits (4位)**：类型特定位
- **Version (32位)**：QUIC协议版本（如0x00000001）
- **Destination Connection ID (可变长度)**：目标连接ID，长度由第一个字节的高4位指定
- **Source Connection ID (可变长度)**：源连接ID
- **Payload Length (16位)**：负载数据长度（不包括头部）
- **Packet Number (可变长度)**：包序号，长度由包类型决定
- **Payload（负载数据）**：**包含加密的TLS握手消息或应用数据**

**TLS与QUIC头部的关系**：
- **TLS不在头部**：TLS握手消息和应用数据都作为加密的Payload传输
- **Initial包**：包含TLS ClientHello，使用初始密钥加密
- **Handshake包**：包含TLS握手消息（ServerHello、Certificate、Finished等）
- **0-RTT包**：包含早期应用数据，使用0-RTT密钥加密
- **短头部包**：包含应用数据，使用1-RTT密钥加密

#### 短头部（Short Header）
用于已建立连接的数据传输，头部更紧凑。

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|0|1|S|R|R|K|T|  |  Destination Connection ID (0-160位)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              Packet Number (8-32位)                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          Payload...                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**字段说明**：
- **Header Form (1位)**：0表示短头部
- **Fixed Bit (1位)**：固定为1
- **Spin Bit (1位)**：用于延迟检测
- **Reserved Bits (2位)**：保留位，必须为0
- **Key Phase (1位)**：密钥阶段，用于密钥轮换
- **Reserved Bit (1位)**：保留位
- **Destination Connection ID (可变长度)**：目标连接ID，0-20字节
- **Packet Number (可变长度)**：包序号，1-4字节
- **Payload**：加密的负载数据

### 关键特性

#### 1. 基于 UDP 与用户态实现
- **UDP 作为传输层**：避免 TCP 的内核实现限制，无需操作系统升级即可部署
- **用户态实现**：网络栈在用户空间运行，降低内核态与用户态切换开销，便于快速迭代协议特性
- **端口选择**：默认使用 UDP 443 端口，提高与现有网络基础设施的兼容性

#### 2. 内置 TLS 1.3 加密
- **握手与加密合并**：将传输层握手与 TLS 握手合并，减少往返次数
- **0-RTT 数据传输**：支持首包发送应用数据，进一步降低延迟
- **全程加密**：除必要的 QUIC 头部字段外，所有数据（包括握手过程）均加密
- **前向安全性**：提供完善的密钥协商机制，保障通信安全

#### 3. 真正的多路复用
- **Stream 机制**：连接内支持多个独立的 Stream，每个 Stream 有序但相互独立
- **无队头阻塞（HOL Blocking）**：单个 Stream 的丢包仅影响该 Stream，不影响其他 Stream
- **双向数据流**：每个 Stream 可独立支持双向数据传输
- **流量控制**：基于 Stream 和连接级别的流量控制窗口

#### 4. 连接迁移
- **Connection ID (CID)**：使用 CID 标识连接，而非依赖传统的四元组（源IP、源端口、目的IP、目的端口）
- **路径验证**：通过 PATH CHALLENGE/PATH RESPONSE 帧验证新路径的可达性
- **无缝切换**：支持 IP/端口变更时的连接无缝迁移（如 Wi-Fi 切换到 4G）
- **密钥复用**：连接迁移后复用原有密钥材料，无需重新握手

#### 5. 拥塞控制与可靠性
- **可插拔拥塞控制**：支持 BBR、CUBIC 等多种拥塞控制算法，可根据场景选择
- **独立包号空间**：初始、握手、应用数据使用独立的包号空间，简化重传逻辑
- **基于帧的确认**：使用 ACK Frame 确认收到的数据，支持累计确认和选择性确认
- **快速重传**：基于超时和重复确认的快速重传机制
- **丢失检测**：通过时间戳和包号分析实现高效的丢失检测

### QUIC 握手流程详解

#### 1. 1-RTT 握手（首次连接）

**1-RTT 握手是 QUIC 协议为首次连接设计的高效握手机制**，通过将传输层握手与 TLS 1.3 握手合并，仅需 1 个往返时间即可完成连接建立并开始传输应用数据。以下是详细的握手过程：

**阶段 1：客户端初始数据包（Client Initial）**
- **时间点**：0ms（开始）
- **发送方**：客户端
- **数据包内容**：
  - **公共头部**：包含 QUIC 版本、连接 ID、包号
  - **Token**：首次连接时为空（后续连接会携带服务器提供的 Token 用于防重放）
  - **TLS Client Hello**：加密的 TLS 客户端问候消息，包含：
    - 支持的密码套件
    - 支持的扩展
    - 随机数
    - 会话票据（首次连接时为空）
  - **QUIC 特定参数**：最大数据包大小、支持的拥塞控制算法等
- **加密状态**：使用临时密钥加密（基于客户端随机数和公共参数）
- **目的**：发起连接请求，协商加密参数和协议版本

**阶段 2：服务器初始数据包（Server Initial）**
- **时间点**：~RTT/2（网络传输时间）
- **发送方**：服务器
- **数据包内容**：
  - **公共头部**：包含服务器生成的连接 ID
  - **Token**：服务器生成的连接令牌（用于后续连接的 0-RTT 快速握手）
  - **TLS Server Hello**：加密的 TLS 服务器问候消息，包含：
    - 选定的密码套件
    - 选定的扩展
    - 服务器随机数
  - **TLS Encrypted Extensions**：加密的扩展信息
  - **TLS Certificate**：服务器证书链
  - **TLS Certificate Verify**：服务器证书验证消息
  - **TLS Finished**：TLS 握手完成消息
  - **QUIC 确认帧**：确认收到客户端的 Initial 数据包
- **加密状态**：使用握手密钥加密（基于双方随机数协商）
- **目的**：响应客户端请求，提供服务器证书，完成 TLS 握手的服务器端部分

**阶段 3：客户端完成握手与首次数据**
- **时间点**：~RTT（完成第一个往返）
- **发送方**：客户端
- **数据包内容**：
  - **TLS Finished**：客户端 TLS 握手完成消息（验证服务器证书和握手过程）
  - **应用数据**：首次应用层数据（如 HTTP/3 请求）
  - **QUIC 确认帧**：确认收到服务器的 Initial 数据包
- **加密状态**：使用应用密钥加密（基于完整握手生成的会话密钥）
- **目的**：完成客户端握手，开始传输应用数据

**阶段 4：服务器响应应用数据**
- **时间点**：~1.5RTT
- **发送方**：服务器
- **数据包内容**：
  - **应用数据**：对客户端请求的响应（如 HTTP/3 响应）
  - **QUIC 确认帧**：确认收到客户端的应用数据
- **加密状态**：使用应用密钥加密
- **目的**：开始正常的数据传输

## IP 协议

负责**逻辑寻址和数据包的路由转发**

### 头部结构

4位IP版本、4位IP数据包首部长度、8位服务类型、16位IP数据包总长度、16位IP数据包ID、3个标志位、13位片偏移量、8位TTL、8位上层协议、16位校验和、32位源IP地址、32位目的IP地址、可选选项

```
0         4         8        12        16        20        24        28        32
+---------+---------+---------+---------+---------+---------+---------+---------+
| Version | Header  |     Type of Service (ToS)      |      Total Length (bytes)   |
|  (4bit) | Length  |         (8 bits)                |         (16 bits)           |
+---------+---------+---------+---------+---------+---------+---------+---------+
|          Identification (16 bits)       | Flags | Fragment Offset (13 bits)  |
+---------+---------+---------+---------+---------+---------+---------+---------+
|      Time To Live (TTL)     |    Protocol (8 bits)    |    Header Checksum     |
|          (8 bits)           |                         |      (16 bits)          |
+---------+---------+---------+---------+---------+---------+---------+---------+
|                    Source IP Address (32 bits)                                |
+---------+---------+---------+---------+---------+---------+---------+---------+
|                 Destination IP Address (32 bits)                              |
+---------+---------+---------+---------+---------+---------+---------+---------+
|                        Options (可选，0-40 字节)                               |
+---------+---------+---------+---------+---------+---------+---------+---------+
|                           Data Payload                                        |
+---------+---------+---------+---------+---------+---------+---------+---------+
```

## DNS 协议

**DNS（Domain Name System）** 是互联网的域名系统，将人类可读的域名（如 google.com）转换为机器可识别的 IP 地址（如 142.251.41.14）。DNS 使用**分布式数据库和递归查询**的方式，高效地完成这个转换过程。

### DNS 查询流程（完整示例）

假设用户在浏览器输入 **www.google.com**，DNS 解析过程如下：

#### 第一步：本地查询（客户端）
```
用户浏览器
  ↓
查看本地缓存（浏览器 DNS 缓存）
  ├─ 如果命中 → 直接返回 IP，流程结束
  └─ 如果未命中 → 继续下一步
  ↓
查询本地 DNS 缓存（操作系统缓存）
  ├─ Windows: ipconfig /displaydns
  ├─ Linux/Mac: 无系统级缓存（由应用管理）
  └─ 如果未命中 → 继续下一步
  ↓
查询 /etc/hosts 文件（本地映射）
  ├─ 如果命中 → 直接返回，流程结束
  └─ 如果未命中 → 继续下一步
```

#### 第二步：递归查询（本地 DNS 解析器）

用户配置的本地 DNS 服务器（通常由 ISP 提供）进行递归查询：

```
本地 DNS 解析器（Recursive Resolver）
  例：8.8.8.8（Google DNS），1.1.1.1（CloudFlare）
  ↓
查询根域名服务器（Root Nameserver）
  位置：全球 13 个根服务器（a-m.root-servers.net）
  查询内容："www.google.com 的权威服务器在哪里？"
  回复："问顶级域名服务器（.com 服务器）去"
  ↓
查询顶级域名服务器（TLD Nameserver）
  位置：.com, .org, .net 等的服务器
  查询内容："google.com 的权威服务器在哪里？"
  回复："问 google.com 的权威服务器去"
  ↓
查询权威域名服务器（Authoritative Nameserver）
  位置：google.com 的 DNS 服务器
  查询内容："www.google.com 的 IP 是多少？"
  回复："142.251.41.14"
  ↓
本地 DNS 缓存该结果
  并返回给用户的 DNS 客户端
  ↓
用户操作系统缓存结果
用户浏览器缓存结果
  ↓
浏览器获得 IP 地址，发起 HTTP/HTTPS 连接
```

## HTTP 协议

**HTTP（HyperText Transfer Protocol）** 是应用层无状态、基于请求-响应的协议，运行在 TCP（或 TLS）之上。它定义了浏览器与服务器如何交换数据，常见版本有 **HTTP/1.1、HTTP/2、HTTP/3**。

### HTTP/1.1
**核心特性**：
- **持久连接**（Keep-Alive）：默认开启，同一TCP连接可复用处理多个请求
- **管线化**（Pipelining）：允许在一个TCP连接上连续发送多个请求，但受限于队头阻塞
- **分块传输编码**（chunked）：支持流式传输，无需提前知道内容长度
- **虚拟主机**（Host头）：单IP多域名支持
- **范围请求**（Range头）：支持断点续传
- **缓存机制完善**：ETag、Last-Modified等

### HTTP/2
**核心改进**：
- **二进制分帧**：将报文拆分为二进制帧，提高解析效率
- **多路复用**：单TCP连接上并行传输多个请求-响应，消除应用层队头阻塞
- **头部压缩**：HPACK算法压缩请求/响应头，减少冗余
- **优先级与流量控制**：为不同请求设置优先级，优化资源加载顺序
- **服务端推送**：服务器可主动推送资源到客户端（实践中多禁用）
- **首部字段优化**：静态表、动态表、Huffman编码减少头部开销

**架构对比**：
```
HTTP/1.1: 连接 → 请求1→响应1→请求2→响应2...（串行）
HTTP/2:   连接 → [帧1,帧2,帧3...帧n]（并行）
```

### HTTP/3
**核心特性**：
- **基于 QUIC/UDP**：替代TCP，彻底消除TCP队头阻塞
- **内置 TLS 1.3**：将传输层和加密层握手合并，减少往返次数
- **连接迁移**：基于Connection ID标识连接，支持网络切换（WiFi→4G）时的快速恢复
- **多路复用**：基于QUIC Stream机制，真正的独立并行传输
- **0-RTT 数据传输**：首次连接第二个RTT即可传输数据，后续支持0-RTT
- **可靠性保障**：QUIC内置重传、拥塞控制、流量控制等机制

## HTTPS 协议

HTTPS（Hypertext Transfer Protocol Secure）即安全超文本传输协议，是HTTP协议的安全版本。它通过在HTTP协议基础上加入SSL/TLS（Secure Sockets Layer/Transport Layer Security）加密层，为网络通信提供加密、身份验证和数据完整性保障。

### 1. HTTPS的基本工作原理
HTTPS的基本工作原理是在HTTP协议基础上加入SSL/TLS加密层，通过以下步骤保障通信安全：
1. 客户端与服务器建立TCP连接
2. 客户端与服务器进行SSL/TLS握手，协商加密算法和密钥
3. 客户端与服务器使用协商好的密钥进行加密通信
4. 通信结束后，关闭SSL/TLS连接和TCP连接

### 2. SSL/TLS协议的作用
SSL/TLS协议是HTTPS的核心，主要提供以下功能：
- **加密**：对传输的数据进行加密，防止被窃听
- **身份验证**：验证通信双方的身份，防止中间人攻击
- **完整性校验**：确保数据在传输过程中不被篡改

### 握手过程

#### TLS 1.2 握手过程（2-RTT）

TLS 1.2握手需要2个往返时间（2-RTT）才能完成密钥协商并开始传输应用数据。

**详细步骤**：

**第1步：ClientHello（客户端问候）**
- **支持的TLS版本**：如TLS 1.2
- **随机数**：32字节，用于生成会话密钥
- **支持的密码套件**：如TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
- **支持的压缩方法**：通常为空（压缩有安全风险）
- **扩展**：如Server Name Indication（SNI）、支持的椭圆曲线等

**第2步：ServerHello + Certificate + ServerHelloDone（服务器响应）**
- **ServerHello**：
  - 选择的TLS版本
  - 服务器随机数
  - 选择的密码套件
  - 会话ID（可选）
- **Certificate**：服务器证书链
- **ServerKeyExchange**：服务器密钥交换参数（如ECDHE公钥）
- **ServerHelloDone**：表示服务器消息发送完毕

**第3步：ClientKeyExchange + ChangeCipherSpec + Finished（客户端完成）**
- **ClientKeyExchange**：客户端密钥交换参数（如ECDHE公钥）
- **ChangeCipherSpec**：通知服务器后续消息将使用协商的密钥加密
- **Finished**：验证握手消息的完整性

**第4步：ChangeCipherSpec + Finished（服务器完成）**
- **ChangeCipherSpec**：通知客户端后续消息将使用协商的密钥加密
- **Finished**：验证握手消息的完整性

**第5步：应用数据传输**
- 双方使用协商好的会话密钥进行加密通信

#### TLS 1.3 握手过程（1-RTT）

TLS 1.3通过优化握手流程，将往返时间从2-RTT减少到1-RTT，大幅提升连接建立速度。

**详细步骤**：

**第1步：ClientHello（客户端问候）**
- **支持的TLS版本**：TLS 1.3
- **随机数**：32字节
- **KeyShare**：客户端的密钥交换参数（如X25519公钥）
- **支持的密码套件**：仅支持AEAD密码套件（如AES_128_GCM_SHA256）
- **支持的签名算法**：如RSA-PSS、ECDSA等

**第2步：ServerHello + Certificate + Finished（服务器响应）**
- **ServerHello**：
  - 选择的TLS版本：TLS 1.3
  - 服务器随机数
  - 选择的密码套件
  - KeyShare：服务器的密钥交换参数（如X25519公钥）
- **Certificate**：服务器证书链
- **Finished**：验证握手消息的完整性

**第3步：Finished（客户端完成）**
- 客户端验证服务器证书
- 计算会话密钥
- 发送Finished消息验证握手完整性

**第4步：应用数据传输**
- 双方使用协商好的会话密钥进行加密通信

#### TLS 1.3 0-RTT 握手（后续连接）

TLS 1.3支持0-RTT数据传输，允许客户端在首次握手后的后续连接中，在第一个往返时间内发送应用数据。

**0-RTT的特点**：
- **会话恢复**：客户端使用之前协商的会话参数
- **早期数据**：客户端在第一个往返时间内发送应用数据
- **安全性限制**：0-RTT数据不保证前向安全性，可能被重放攻击
- **适用场景**：适合非敏感数据的快速传输

## ICMP 协议

ICMP（Internet Control Message Protocol，互联网控制消息协议）是 TCP/IP 协议簇中的一个核心协议，**位于网络层**，用于在 IP 主机、路由器之间传递控制消息和差错报告。ICMP 报文封装在 IP 数据报内进行传输（IP 协议号为 1），本身**不提供端口概念**，也不直接用于传输应用层数据。

### 报文结构

ICMP报文由**通用头部**和**类型特定部分**组成，封装在IP数据报中传输。

#### 通用头部结构

所有ICMP报文都包含以下通用头部字段：

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type (8位)  |     Code (8位)  |        Checksum (16位)      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   类型特定部分（可变长度）                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**字段说明**：
- **Type（8位）**：标识ICMP报文类型
- **Code（8位）**：提供该类型的进一步信息
- **Checksum（16位）**：整个ICMP报文的校验和（包括头部和数据）
- **类型特定部分**：根据Type和Code的不同，包含不同的数据

### 常见 ICMP 报文类型

#### 1. 回显请求/应答（Echo Request/Reply）
- **Type/Code**：8/0（请求）、0/0（应答）
- **用途**：用于网络连通性测试（如 ping 命令）
- **特点**：请求和应答保持相同的 Identifier、Sequence 和数据部分

#### 2. 目标不可达（Destination Unreachable）
- **Type**：3
- **常见 Code**：
  - 0：网络不可达（Network Unreachable）
  - 1：主机不可达（Host Unreachable）
  - 3：端口不可达（Port Unreachable）- UDP 特有
  - 4：需要分片但 DF（Don't Fragment）位已设置
  - 5：源路由失败（Source Route Failed）
- **用途**：当路由器或主机无法将数据报转发到目标时返回

#### 3. 超时（Time Exceeded）
- **Type**：11
- **常见 Code**：
  - 0：TTL 超时（TTL Expired in Transit）
  - 1：分片重组超时（Fragment Reassembly Time Exceeded）
- **用途**：TTL 减至 0 时路由器返回该报文（支撑 traceroute）；或接收端重组分片超时

#### 4. 参数问题（Parameter Problem）
- **Type**：12
- **常见 Code**：
  - 0：IP 首部参数错误
  - 1：缺少必要选项
- **用途**：当接收方发现 IP 首部或 ICMP 首部存在错误时返回

#### 5. 重定向（Redirect Message）
- **Type**：5
- **常见 Code**：
  - 0：网络重定向（Network Redirect）
  - 1：主机重定向（Host Redirect）
  - 2：网络 TOS 重定向（Network TOS Redirect）
  - 3：主机 TOS 重定向（Host TOS Redirect）
- **用途**：路由器通知源主机使用更优的下一跳路径
